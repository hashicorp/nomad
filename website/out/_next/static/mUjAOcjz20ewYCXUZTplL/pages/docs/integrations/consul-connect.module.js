(window.webpackJsonp=window.webpackJsonp||[]).push([[205],{DL0s:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return l}));var n=t("wx14"),c=t("Ff2n"),s=t("q1tI"),o=t.n(s),b=t("7ljp"),p=t("j1un"),r=(o.a.createElement,{}),m=Object(p.a)({layout:"docs",page_title:"Consul Connect",sidebar_title:"Consul Connect",description:"Learn how to use Nomad with Consul Connect to enable secure service to service communication",__resourcePath:"docs/integrations/consul-connect.mdx",__scans:{}});function l(e){var{components:a}=e,t=Object(c.a)(e,["components"]);return Object(b.b)(m,Object(n.a)({},r,t,{components:a,mdxType:"MDXLayout"}),Object(b.b)("h1",{className:"g-type-display-2"},Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__permalink-h",href:"#consul-connect","aria-label":"consul connect permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__target-h",id:"consul-connect","aria-hidden":""})),"Consul Connect"),Object(b.b)("div",{className:"alert alert-warning g-type-body",role:"alert"},Object(b.b)("p",{parentName:"div"},"",Object(b.b)("strong",{parentName:"p"},"Note:")," This guide requires Nomad 0.10.0 or later and Consul 1.6.0 or\nlater.")),Object(b.b)("div",{className:"alert alert-warning g-type-body",role:"alert"},Object(b.b)("p",{parentName:"div"},"",Object(b.b)("strong",{parentName:"p"},"Note:")," Nomad's Connect integration requires Linux network namespaces.\nNomad Connect will not run on Windows or macOS.")),Object(b.b)("p",null,Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.consul.io/docs/connect"}),"Consul Connect")," provides\nservice-to-service connection authorization and encryption using mutual\nTransport Layer Security (TLS). Applications can use sidecar proxies in a\nservice mesh configuration to automatically establish TLS connections for\ninbound and outbound connections without being aware of Connect at all."),Object(b.b)("h1",{className:"g-type-display-2"},Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__permalink-h",href:"#nomad-with-consul-connect-integration","aria-label":"nomad with consul connect integration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__target-h",id:"nomad-with-consul-connect-integration","aria-hidden":""})),"Nomad with Consul Connect Integration"),Object(b.b)("p",null,"Nomad integrates with Consul to provide secure service-to-service communication\nbetween Nomad jobs and task groups. In order to support Consul Connect, Nomad\nadds a new networking mode for jobs that enables tasks in the same task group to\nshare their networking stack. With a few changes to the job specification, job\nauthors can opt into Connect integration. When Connect is enabled, Nomad will\nlaunch a proxy alongside the application in the job file. The proxy (Envoy)\nprovides secure communication with other applications in the cluster."),Object(b.b)("p",null,"Nomad job specification authors can use Nomad's Consul Connect integration to\nimplement ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.consul.io/segmentation.html"}),"service segmentation")," in a\nmicroservice architecture running in public clouds without having to directly\nmanage TLS certificates. This is transparent to job specification authors as\nsecurity features in Connect continue to work even as the application scales up\nor down or gets rescheduled by Nomad."),Object(b.b)("p",null,"For using the Consul Connect integration with Consul ACLs enabled, see the\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://learn.hashicorp.com/nomad/consul-integration/nomad-connect-acl"}),"Secure Nomad Jobs with Consul Connect"),"\nguide."),Object(b.b)("h1",{className:"g-type-display-2"},Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__permalink-h",href:"#nomad-consul-connect-example","aria-label":"nomad consul connect example permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__target-h",id:"nomad-consul-connect-example","aria-hidden":""})),"Nomad Consul Connect Example"),Object(b.b)("p",null,"The following section walks through an example to enable secure communication\nbetween a web dashboard and a backend counting service. The web dashboard and\nthe counting service are managed by Nomad. Nomad additionally configures Envoy\nproxies to run along side these applications. The dashboard is configured to\nconnect to the counting service via localhost on port 9001. The proxy is managed\nby Nomad, and handles mTLS communication to the counting service."),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#prerequisites","aria-label":"prerequisites permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"prerequisites","aria-hidden":""})),"Prerequisites"),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#consul","aria-label":"consul permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"consul","aria-hidden":""})),"Consul"),Object(b.b)("p",null,"Connect integration with Nomad requires ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://releases.hashicorp.com/consul/1.6.0/"}),"Consul 1.6 or\nlater.")," The Consul agent can be\nrun in dev mode with the following command:"),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Note"),": Nomad's Connect integration requires Consul in your ",Object(b.b)("inlineCode",{parentName:"p"},"$PATH")),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"consul agent -dev")),"\n")),Object(b.b)("p",null,"To use Connect on a non-dev Consul agent, you will minimally need to enable the\nGRPC port and set ",Object(b.b)("inlineCode",{parentName:"p"},"connect")," to enabled by adding some additional information to\nyour Consul client configurations, depending on format."),Object(b.b)("p",null,"For HCL configurations:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# ..."),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"ports")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"grpc")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"8502"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"connect")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"enabled")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"For JSON configurations:"),Object(b.b)("pre",{className:"language-javascript"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"// ..."),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"ports"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"grpc"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"8502"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"connect"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n     ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"enabled"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#nomad","aria-label":"nomad permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"nomad","aria-hidden":""})),"Nomad"),Object(b.b)("p",null,"Nomad must schedule onto a routable interface in order for the proxies to\nconnect to each other. The following steps show how to start a Nomad dev agent\nconfigured for Connect."),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"sudo")," nomad agent -dev-connect")),"\n")),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#cni-plugins","aria-label":"cni plugins permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"cni-plugins","aria-hidden":""})),"CNI Plugins"),Object(b.b)("p",null,"Nomad uses CNI plugins to configure the network namespace used to secure the\nConsul Connect sidecar proxy. All Nomad client nodes using network namespaces\nmust have CNI plugins installed."),Object(b.b)("p",null,"The following commands install CNI plugins:"),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"curl")," -L -o cni-plugins.tgz https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz")),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"sudo")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"mkdir")," -p /opt/cni/bin")),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"sudo")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"tar")," -C /opt/cni/bin -xzf cni-plugins.tgz")),"\n")),Object(b.b)("p",null,"Ensure the your Linux operating system distribution has been configured to allow\ncontainer traffic through the bridge network to be routed via iptables. These\ntunables can be set as follows:"),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token builtin class-name"}),"echo")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token number"}),"1")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),">")," /proc/sys/net/bridge/bridge-nf-call-arptables")),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token builtin class-name"}),"echo")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token number"}),"1")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),">")," /proc/sys/net/bridge/bridge-nf-call-ip6tables")),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token builtin class-name"}),"echo")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token number"}),"1")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),">")," /proc/sys/net/bridge/bridge-nf-call-iptables")),"\n")),Object(b.b)("p",null,"To preserve these settings on startup of a client node, add a file including the\nfollowing to ",Object(b.b)("inlineCode",{parentName:"p"},"/etc/sysctl.d/")," or remove the file your Linux distribution puts in\nthat directory."),Object(b.b)("pre",null,Object(b.b)("code",Object(n.a)({parentName:"pre"},{}),"net.bridge.bridge-nf-call-arptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\n")),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#run-the-connect-enabled-services","aria-label":"run the connect enabled services permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"run-the-connect-enabled-services","aria-hidden":""})),"Run the Connect-enabled Services"),Object(b.b)("p",null,"Once Nomad and Consul are running, submit the following Connect-enabled services\nto Nomad by copying the HCL into a file named ",Object(b.b)("inlineCode",{parentName:"p"},"connect.nomad")," and running:\n",Object(b.b)("inlineCode",{parentName:"p"},"nomad run connect.nomad")),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"job ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"countdash"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"datacenters")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"dc1"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n\n  group ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"api"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"network")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"mode")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"bridge"'),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"service")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"name")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"count-api"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"port")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"9001"'),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"connect")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"sidecar_service")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n    task ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"web"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"driver")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"docker"'),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"config")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"image")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"hashicorpnomad/counter-api:v1"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n  group ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"dashboard"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"network")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"mode")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"bridge"'),"\n\n      port ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"http"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"static")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"9002"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"to"),"     ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"9002"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"service")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"name")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"count-dashboard"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"port")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"9002"'),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"connect")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"sidecar_service")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n          ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"proxy")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n            ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"upstreams")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n              ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"destination_name")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"count-api"'),"\n              ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"local_bind_port"),"  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"8080"),"\n            ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n          ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n    task ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"dashboard"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"driver")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"docker"'),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"env")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"COUNTING_SERVICE_URL")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"http://',Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token interpolation"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"$"),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"{"),"NOMAD_UPSTREAM_ADDR_count_api",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"}")),'"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"config")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"image")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"hashicorpnomad/counter-dashboard:v1"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"The job contains two task groups: an API service and a web frontend."),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#api-service","aria-label":"api service permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"api-service","aria-hidden":""})),"API Service"),Object(b.b)("p",null,"The API service is defined as a task group with a bridge network:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"  group ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"api"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"network")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"mode")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"bridge"'),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# ..."),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"Since the API service is only accessible via Consul Connect, it does not define\nany ports in its network. The service stanza enables Connect:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"  group ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"api"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# ..."),"\n\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"service")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"name")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"count-api"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"port")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"9001"'),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"connect")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"sidecar_service")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# ..."),"\n\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"port")," in the service stanza is the port the API service listens on. The\nEnvoy proxy will automatically route traffic to that port inside the network\nnamespace."),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#web-frontend","aria-label":"web frontend permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"web-frontend","aria-hidden":""})),"Web Frontend"),Object(b.b)("p",null,"The web frontend is defined as a task group with a bridge network and a static\nforwarded port:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"  group ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"dashboard"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"network")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"mode")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"bridge"'),"\n\n      port ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"http"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"static")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"9002"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"to"),"     ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"9002"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# ..."),"\n\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"static = 9002")," parameter requests the Nomad scheduler reserve port 9002 on\na host network interface. The ",Object(b.b)("inlineCode",{parentName:"p"},"to = 9002")," parameter forwards that host port to\nport 9002 inside the network namespace."),Object(b.b)("p",null,"This allows you to connect to the web frontend in a browser by visiting\n",Object(b.b)("inlineCode",{parentName:"p"},"http://<host_ip>:9002")," as show below:"),Object(b.b)("p",null,Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/img/count-dashboard.png"}),Object(b.b)("img",Object(n.a)({parentName:"a"},{src:"/img/count-dashboard.png",alt:"Count Dashboard"})))),Object(b.b)("p",null,"The web frontend connects to the API service via Consul Connect:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"service")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"name")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"count-dashboard"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"port")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"9002"'),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"connect")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"sidecar_service")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n          ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"proxy")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n            ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"upstreams")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n              ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"destination_name")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"count-api"'),"\n              ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"local_bind_port"),"  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"8080"),"\n            ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n          ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"upstreams")," stanza defines the remote service to access (",Object(b.b)("inlineCode",{parentName:"p"},"count-api"),") and\nwhat port to expose that service on inside the network namespace (",Object(b.b)("inlineCode",{parentName:"p"},"8080"),")."),Object(b.b)("p",null,"The web frontend is configured to communicate with the API service with an\nenvironment variable:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"env")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"COUNTING_SERVICE_URL")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"http://',Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token interpolation"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"$"),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"{"),"NOMAD_UPSTREAM_ADDR_count_api",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"}")),'"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"The web frontend is configured via the ",Object(b.b)("inlineCode",{parentName:"p"},"$COUNTING_SERVICE_URL"),", so you must\ninterpolate the upstream's address into that environment variable. Note that\ndashes (",Object(b.b)("inlineCode",{parentName:"p"},"-"),") are converted to underscores (",Object(b.b)("inlineCode",{parentName:"p"},"_"),") in environment variables so\n",Object(b.b)("inlineCode",{parentName:"p"},"count-api")," becomes ",Object(b.b)("inlineCode",{parentName:"p"},"count_api"),"."),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#limitations","aria-label":"limitations permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"limitations","aria-hidden":""})),"Limitations"),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),"The ",Object(b.b)("inlineCode",{parentName:"li"},"consul")," binary must be present in Nomad's ",Object(b.b)("inlineCode",{parentName:"li"},"$PATH")," to run the Envoy\nproxy sidecar on client nodes."),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),"Changes to the ",Object(b.b)("inlineCode",{parentName:"li"},"connect")," stanza may not properly trigger a job update\n(",Object(b.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/hashicorp/nomad/issues/6459"}),"#6459"),"). Changing a ",Object(b.b)("inlineCode",{parentName:"li"},"meta")," variable is the suggested workaround as\nthis will always cause an update to occur."),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),"Consul Connect using network namespaces is only supported on Linux.")))}l.isMDXComponent=!0},S7dw:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/integrations/consul-connect",function(){return t("DL0s")}])}},[["S7dw",0,1,2,4,3,5,6]]]);