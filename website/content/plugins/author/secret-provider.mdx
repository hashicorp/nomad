---
layout: docs
page_title: Create a secret provider plugin
description: |-
  Use Nomad's secret provider plugins specification to create a secret provider plugin so that you can use secrets in your tasks from any secrets store.
---

# Create a secret provider plugin

This page describes the plugin specification for
[custom secret providers][custom-providers], with examples, so you can write
your own plugin to utilize secrets from any secrets store.

The full [specification](#specification) follows the examples,
and is followed by a list of [general considerations](#considerations).

## Examples

The specification is lean enough to be readily fulfilled in any language.
The following examples are written in `bash`.

The `custom-mkdir` plugin creates a directory, and `mkfs-ext4` creates a Linux
filesystem. You may imagine others, such as an NFS mount or another
storage infrastructure API.

Each example includes a minimal [secret specification][], which assumes that
you have placed the plugin in the [client.common_plugins_dir/secrets/][common_plugins_dir]
and made it executable.

<Tabs>
<Tab heading="aws">

`aws` fetches a secret from AWS Secret Manager. It is expected the plugin code below
will be compiled into a binary named "aws". The code provided is not meant to be
inclusive of all error handling, but to be used as an example.

Secret specification:

```hcl
secret "foo" {
  provider = "aws"
  path = "aws-secret-name"
  env {
    AWS_REGION = "us-east-2"
  }
}
```

Plugin code:

```golang

package main

import (
	"context"
	"fmt"
	"os"

	"github.com/aws/aws-sdk-go-v2/config"
	"github.com/aws/aws-sdk-go-v2/service/secretsmanager"
	"github.com/aws/aws-sdk-go/aws"
)

const generalUsage = "Must be run with either 'fingerprint' or 'fetch'. \nFetch must be passed the path of the secret"

func returnErr(err string) {
	fmt.Printf(`{"error": "%s"}`, err)
	os.Exit(1)
}

func main() {
	if len(os.Args) < 2 {
		returnErr("internal error not enough args")
	}

	switch os.Args[1] {
	case "fingerprint":
		fingerprint()
	case "fetch":
		// fetch should be called with the correct secret path
		if len(os.Args) < 3 {
			returnErr("interal error no path specified")
		}
		fetch(os.Args[2])
	default:
		returnErr("internal error incorrect function")
	}
}

func fingerprint() {
	fmt.Println(`{"type": "secrets", "version": "0.0.1"}`)
}

// see: https://docs.aws.amazon.com/secretsmanager/latest/userguide/retrieving-secrets-go-sdk.html
func fetch(secretName string) {
	ctx := context.Background()

	config, err := config.LoadDefaultConfig(ctx, config.WithRegion(os.Getenv("AWS_REGION")))
	if err != nil {
		returnErr("error loading default aws config")
	}

	// Create Secrets Manager client
	svc := secretsmanager.NewFromConfig(config)

	input := &secretsmanager.GetSecretValueInput{
		SecretId:     aws.String(secretName),
		VersionStage: aws.String("AWSCURRENT"),
	}

	result, err := svc.GetSecretValue(ctx, input)
	if err != nil {
		returnErr(err.Error())
	}

	// Decrypts secret using the associated KMS key.
	var secretString string = *result.SecretString

	fmt.Printf(`{"result": "%s"}`, secretString)
}
```

</Tab>
</Tabs>

## Specification

A secret provider plugin is registered with Nomad if it:

- Is an executable file, such as a script or binary
- Is located in the [`client.common_plugin_dir/secrets/`][plugin_dir] directory
  on Nomad client nodes
- Responds appropriately to a `fingerprint` call

### Operations

To fully manage the lifecycle of a volume, plugins must fulfill all of the
following operations:

- [fingerprint](#fingerprint)
- [fetch](#fetch)

Nomad passes the operation as the first positional argument to the plugin.
That and other information are passed as environment variables. Environment
variables are prefixed with `"CPI_"`, which stands for "Dynamic Host Volume."

#### fingerprint

<blockquote style={{borderLeft: "solid 1px #00ca8e"}}>

Nomad calls `fingerprint` to discover valid plugins when the client agent
starts or is reloaded with a SIGHUP. The version it returns is used to register
the plugin on the Nomad node for volume scheduling.

**CLI arguments:** `$1=fingerprint`

**Environment variables:**

```
CPI_OPERATION=fingerprint
```

**Expected stdout:**

```
{"type": "secrets", "version": "0.0.1"}
```

**Requirements:**

- Must complete within 10 seconds, or Nomad will kill it. It should be much
  faster, as no actual work should be done.
- "type" registers this as a secret provider plugin.
- "version" value must be valid per the [hashicorp/go-version][go-version]
  golang package.

</blockquote>

#### fetch

<blockquote style={{borderLeft: "solid 1px #00ca8e"}}>

Nomad calls `fetch` when a nomad job includes a secrets block with
a provider registered as a plugin. When calling fetch, Nomad will
include the secret path as the second CLI argument. If the `env{}`
block was specified, any key/values will be supplied as environment
variables to the plugin process.

**CLI Arguments:** `$1=fetch $2=path`

**Environment variables:**

```
CPI_OPERATION=fetch
```

**Expected stdout:**

```
{"result": {"key1": "value1", "key2": "value2"}}
```

**Expected stdout on error:**

```
{"result": {}, "error": "error message"}
```

Returning an error message is optional. Nomad returns the error message in any
error returned to the user.

**Requirements:**

- Must complete within 10 seconds, or Nomad will kill it.
- Must return secret contents as a key/value object, even if the secret
  was not originally in key/value format.

</blockquote>

### Execution

- The plugin is executed as the same user as the `nomad` agent (likely root).

[custom-providers]: /nomad/docs/job-specification/secret#custom-providers
[go-version]: https://pkg.go.dev/github.com/hashicorp/go-version#pkg-constants
[common_plugins_dir]: /nomad/docs/configuration/client#common_plugins_dir
