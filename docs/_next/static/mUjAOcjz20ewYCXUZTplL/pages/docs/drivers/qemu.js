(window.webpackJsonp=window.webpackJsonp||[]).push([[193],{HMoM:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/drivers/qemu",function(){return t("ihwN")}])},ihwN:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return p}));var n=t("wx14"),c=t("Ff2n"),i=t("q1tI"),r=t.n(i),b=t("7ljp"),s=t("j1un"),l=(r.a.createElement,{}),o=Object(s.a)({layout:"docs",page_title:"Drivers: Qemu",sidebar_title:"Qemu",description:"The Qemu task driver is used to run virtual machines using Qemu/KVM.",__resourcePath:"docs/drivers/qemu.mdx",__scans:{}});function p(e){var a=e.components,t=Object(c.a)(e,["components"]);return Object(b.b)(o,Object(n.a)({},l,t,{components:a,mdxType:"MDXLayout"}),Object(b.b)("h1",{className:"g-type-display-2"},Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__permalink-h",href:"#qemu-driver","aria-label":"qemu driver permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__target-h",id:"qemu-driver","aria-hidden":""})),"Qemu Driver"),Object(b.b)("p",null,"Name: ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," driver provides a generic virtual machine runner. Qemu can utilize\nthe KVM kernel module to utilize hardware virtualization features and provide\ngreat performance. Currently the ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," driver can map a set of ports from the\nhost machine to the guest virtual machine, and provides configuration for\nresource allocation."),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," driver can execute any regular ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," image (e.g. ",Object(b.b)("inlineCode",{parentName:"p"},"qcow"),", ",Object(b.b)("inlineCode",{parentName:"p"},"img"),",\n",Object(b.b)("inlineCode",{parentName:"p"},"iso"),"), and is currently invoked with ",Object(b.b)("inlineCode",{parentName:"p"},"qemu-system-x86_64"),"."),Object(b.b)("p",null,"The driver requires the image to be accessible from the Nomad client via the\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/job-specification/artifact"}),Object(b.b)("inlineCode",{parentName:"a"},"artifact")," downloader"),"."),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#task-configuration","aria-label":"task configuration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"task-configuration","aria-hidden":""})),"Task Configuration"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"task ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"webservice"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"driver")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"qemu"'),"\n\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"config")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"image_path"),"        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/path/to/my/linux.img"'),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"accelerator"),"       ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"kvm"'),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"graceful_shutdown")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"args"),"              ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"-nodefaults"'),", ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"-nodefconfig"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," driver supports the following configuration in the job spec:"),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"image_path",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#image_path","aria-label":"image_path permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"image_path"))," - The path to the downloaded image. In most cases this will just\nbe the name of the image. However, if the supplied artifact is an archive that\ncontains the image in a subfolder, the path will need to be the relative path\n(",Object(b.b)("inlineCode",{parentName:"p"},"subdir/from_archive/my.img"),").")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"accelerator",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#accelerator","aria-label":"accelerator permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"accelerator"))," - (Optional) The type of accelerator to use in the invocation.\nIf the host machine has ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," installed with KVM support, users can specify\n",Object(b.b)("inlineCode",{parentName:"p"},"kvm")," for the ",Object(b.b)("inlineCode",{parentName:"p"},"accelerator"),". Default is ",Object(b.b)("inlineCode",{parentName:"p"},"tcg"),".")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"graceful_shutdown",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#graceful_shutdown","aria-label":"graceful_shutdown permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"graceful_shutdown"))," ",Object(b.b)("inlineCode",{parentName:"p"},"(bool: false)")," - Using the ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://en.wikibooks.org/wiki/QEMU/Monitor"}),"qemu\nmonitor"),", send an ACPI shutdown\nsignal to virtual machines rather than simply terminating them. This emulates\na physical power button press, and gives instances a chance to shut down\ncleanly. If the VM is still running after ",Object(b.b)("inlineCode",{parentName:"p"},"kill_timeout"),", it will be\nforcefully terminated. (Note that\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/qemu/qemu/commit/ad9579aaa16d5b385922d49edac2c96c79bcfb6"}),"prior to qemu 2.10.1"),",\nthe monitor socket path is limited to 108 characters. Graceful shutdown will\nbe disabled if qemu is < 2.10.1 and the generated monitor path exceeds this\nlength. You may encounter this issue if you set long\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration#data_dir"}),"data_dir"),"\nor\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration/client#alloc_dir"}),"alloc_dir"),"\npaths.) This feature is currently not supported on Windows.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"port_map",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#port_map","aria-label":"port_map permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"port_map"))," - (Optional) A key-value map of port labels."),Object(b.b)("pre",Object(n.a)({parentName:"li"},{className:"language-hcl"}),Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"config")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),'# Forward the host port with the label "db" to the guest VM\'s port 6539.'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"port_map")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"db")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"6539"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n"))),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"args",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#args","aria-label":"args permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"args"))," - (Optional) A list of strings that is passed to qemu as command line\noptions."))),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#examples","aria-label":"examples permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"examples","aria-hidden":""})),"Examples"),Object(b.b)("p",null,"A simple config block to run a ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," image:"),Object(b.b)("pre",null,Object(b.b)("code",Object(n.a)({parentName:"pre"},{}),'task "virtual" {\n  driver = "qemu"\n\n  config {\n    image_path  = "local/linux.img"\n    accelerator = "kvm"\n    args        = ["-nodefaults", "-nodefconfig"]\n  }\n\n  # Specifying an artifact is required with the "qemu"\n  # driver. This is the # mechanism to ship the image to be run.\n  artifact {\n    source = "https://internal.file.server/linux.img"\n\n    options {\n      checksum = "md5:123445555555555"\n    }\n  }\n')),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#capabilities","aria-label":"capabilities permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"capabilities","aria-hidden":""})),"Capabilities"),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," driver implements the following ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/internals/plugins/task-drivers#capabilities-capabilities-error"}),"capabilities"),"."),Object(b.b)("table",null,Object(b.b)("thead",{parentName:"table"},Object(b.b)("tr",{parentName:"thead"},Object(b.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Feature"),Object(b.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Implementation"))),Object(b.b)("tbody",{parentName:"table"},Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"nomad alloc signal")),Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"false")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(b.b)("inlineCode",{parentName:"td"},"nomad alloc exec")),Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"false")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"filesystem isolation"),Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"image")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"network isolation"),Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"none")),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"volume mounting"),Object(b.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"none")))),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#client-requirements","aria-label":"client requirements permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"client-requirements","aria-hidden":""})),"Client Requirements"),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," driver requires Qemu to be installed and in your system's ",Object(b.b)("inlineCode",{parentName:"p"},"$PATH"),".\nThe task must also specify at least one artifact to download, as this is the only\nway to retrieve the image being run."),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#client-attributes","aria-label":"client attributes permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"client-attributes","aria-hidden":""})),"Client Attributes"),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"qemu")," driver will set the following client attributes:"),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"driver-qemu",className:"__target-lic","aria-hidden":""})),Object(b.b)("a",Object(n.a)({parentName:"li"},{href:"#driver-qemu","aria-label":"driver qemu permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"driver.qemu"))," - Set to ",Object(b.b)("inlineCode",{parentName:"li"},"1")," if Qemu is found on the host node. Nomad determines\nthis by executing ",Object(b.b)("inlineCode",{parentName:"li"},"qemu-system-x86_64 -version")," on the host and parsing the output"),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"driver-qemu-version",className:"__target-lic","aria-hidden":""})),Object(b.b)("a",Object(n.a)({parentName:"li"},{href:"#driver-qemu-version","aria-label":"driver qemu version permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"driver.qemu.version"))," - Version of ",Object(b.b)("inlineCode",{parentName:"li"},"qemu-system-x86_64"),", ex: ",Object(b.b)("inlineCode",{parentName:"li"},"2.4.0"))),Object(b.b)("p",null,"Here is an example of using these properties in a job file:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"job ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"docs"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# Only run this job where the qemu version is higher than 1.2.3."),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"constraint")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"attribute")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"',Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token interpolation"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"$"),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"{"),"driver",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"."),"qemu",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"."),"version",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token punctuation"}),"}")),'"'),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"operator"),"  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'">"'),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"value"),"     ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"1.2.3"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#plugin-options","aria-label":"plugin options permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"plugin-options","aria-hidden":""})),"Plugin Options"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"plugin ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"qemu"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"config")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"image_paths")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/mnt/image/paths"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"image_paths",className:"__target-lic","aria-hidden":""})),Object(b.b)("a",Object(n.a)({parentName:"li"},{href:"#image_paths","aria-label":"image_paths permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"image_paths"))," (",Object(b.b)("inlineCode",{parentName:"li"},"[]string"),": ",Object(b.b)("inlineCode",{parentName:"li"},"[]"),") - Specifies the host paths the Qemu driver is\nallowed to load images from.")),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#resource-isolation","aria-label":"resource isolation permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"resource-isolation","aria-hidden":""})),"Resource Isolation"),Object(b.b)("p",null,"Nomad uses Qemu to provide full software virtualization for virtual machine\nworkloads. Nomad can use Qemu KVM's hardware-assisted virtualization to deliver\nbetter performance."),Object(b.b)("p",null,"Virtualization provides the highest level of isolation for workloads that\nrequire additional security, and resource use is constrained by the Qemu\nhypervisor rather than the host kernel. VM network traffic still flows through\nthe host's interface(s)."))}p.isMDXComponent=!0}},[["HMoM",0,1,2,4,3,5,6]]]);