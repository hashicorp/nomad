(window.webpackJsonp=window.webpackJsonp||[]).push([[228],{"Trc/":function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return j}));var n,c=t("wx14"),s=t("Ff2n"),o=t("q1tI"),p=t.n(o),b=t("7ljp"),r=t("j1un"),i=(p.a.createElement,n="Placement",function(e){return console.warn("Component "+n+" was not imported, exported, or provided by MDXProvider as global scope"),Object(b.b)("div",e)}),l={},m=Object(r.a)({layout:"docs",page_title:"csi_plugin Stanza - Job Specification",sidebar_title:"csi_plugin <sup>Beta</sup>",description:'The "csi_plugin" stanza allows the task to specify it provides a Container Storage Interface plugin to the cluster.',__resourcePath:"docs/job-specification/csi_plugin.mdx",__scans:{}});function j(e){var a=e.components,t=Object(s.a)(e,["components"]);return Object(b.b)(m,Object(c.a)({},l,t,{components:a,mdxType:"MDXLayout"}),Object(b.b)("h1",{className:"g-type-display-2"},Object(b.b)("a",Object(c.a)({parentName:"h1"},{className:"__permalink-h",href:"#csi_plugin-stanza","aria-label":"csi_plugin stanza permalink"}),"\xbb"),Object(b.b)("a",Object(c.a)({parentName:"h1"},{className:"__target-h",id:"csi_plugin-stanza","aria-hidden":""})),Object(b.b)("inlineCode",{parentName:"h1"},"csi_plugin")," Stanza"),Object(b.b)(i,{groups:["job","group","task","volume"],mdxType:"Placement"}),Object(b.b)("p",null,'The "csi_plugin" stanza allows the task to specify it provides a\nContainer Storage Interface plugin to the cluster. Nomad will\nautomatically register the plugin so that it can be used by other jobs\nto claim ',Object(b.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/job-specification/volume"}),"volumes"),"."),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"csi_plugin")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"id"),"        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"csi-hostpath"'),"\n  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"type"),"      ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"monolith"'),"\n  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"mount_dir")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"/csi"'),"\n",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#csi_plugin-parameters","aria-label":"csi_plugin parameters permalink"}),"\xbb"),Object(b.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"csi_plugin-parameters","aria-hidden":""})),Object(b.b)("inlineCode",{parentName:"h2"},"csi_plugin")," Parameters"),Object(b.b)("ul",null,Object(b.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(c.a)({parentName:"li"},{id:"id",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(c.a)({parentName:"p"},{href:"#id","aria-label":"id permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"id"))," ",Object(b.b)("inlineCode",{parentName:"p"},"(string: <required>)")," - This is the ID for the plugin. Some\nplugins will require both controller and node plugin types (see\nbelow); you need to use the same ID for both so that Nomad knows the\nbelong to the same plugin.")),Object(b.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(c.a)({parentName:"li"},{id:"type",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(c.a)({parentName:"p"},{href:"#type","aria-label":"type permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"type"))," ",Object(b.b)("inlineCode",{parentName:"p"},"(string: <required>)")," - One of ",Object(b.b)("inlineCode",{parentName:"p"},"node"),", ",Object(b.b)("inlineCode",{parentName:"p"},"controller"),", or\n",Object(b.b)("inlineCode",{parentName:"p"},"monolith"),". Each plugin supports one or more types. Each Nomad\nclient node where you want to mount a volume will need a ",Object(b.b)("inlineCode",{parentName:"p"},"node"),"\nplugin instance. Some plugins will also require one or more\n",Object(b.b)("inlineCode",{parentName:"p"},"controller")," plugin instances to communicate with the storage\nprovider's APIs. Some plugins can serve as both ",Object(b.b)("inlineCode",{parentName:"p"},"controller")," and\n",Object(b.b)("inlineCode",{parentName:"p"},"node")," at the same time, and these are called ",Object(b.b)("inlineCode",{parentName:"p"},"monolith"),"\nplugins. Refer to your CSI plugin's documentation.")),Object(b.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(c.a)({parentName:"li"},{id:"mount_dir",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(c.a)({parentName:"p"},{href:"#mount_dir","aria-label":"mount_dir permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"mount_dir"))," ",Object(b.b)("inlineCode",{parentName:"p"},"(string: <required>)")," - The directory path inside the\ncontainer where the plugin will expect a Unix domain socket for\nbidirectional communication with Nomad."))),Object(b.b)("div",{className:"alert alert-warning g-type-body",role:"alert"},Object(b.b)("p",{parentName:"div"},"",Object(b.b)("strong",{parentName:"p"},"Note:")," Plugins running as ",Object(b.b)("inlineCode",{parentName:"p"},"node")," or ",Object(b.b)("inlineCode",{parentName:"p"},"monolith")," require root\nprivileges (or ",Object(b.b)("inlineCode",{parentName:"p"},"CAP_SYS_ADMIN")," on Linux) to mount volumes on the\nhost. With the Docker task driver, you can use the ",Object(b.b)("inlineCode",{parentName:"p"},"privileged = true"),"\nconfiguration, but no other default task drivers currently have this\noption.")),Object(b.b)("div",{className:"alert alert-warning g-type-body",role:"alert"},Object(b.b)("p",{parentName:"div"},"",Object(b.b)("strong",{parentName:"p"},"Note:")," During node drains, jobs that claim volumes must be moved before\nthe ",Object(b.b)("inlineCode",{parentName:"p"},"node")," or ",Object(b.b)("inlineCode",{parentName:"p"},"monolith")," plugin for those volumes. You should run ",Object(b.b)("inlineCode",{parentName:"p"},"node")," or\n",Object(b.b)("inlineCode",{parentName:"p"},"monolith")," plugins as ",Object(b.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/schedulers/#system"}),Object(b.b)("inlineCode",{parentName:"a"},"system"))," jobs and use the ",Object(b.b)("inlineCode",{parentName:"p"},"-ignore-system"),"\nflag on ",Object(b.b)("inlineCode",{parentName:"p"},"nomad node drain")," to ensure that the plugins are running while the\nnode is being drained.")),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#csi_plugin-examples","aria-label":"csi_plugin examples permalink"}),"\xbb"),Object(b.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"csi_plugin-examples","aria-hidden":""})),Object(b.b)("inlineCode",{parentName:"h2"},"csi_plugin")," Examples"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),"job ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"plugin-efs"')," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"datacenters")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"dc1"'),Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n\n  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# you can run node plugins as service jobs as well, but running"),"\n  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# as a system job ensures all nodes in the DC have a copy."),"\n  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"type")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"system"'),"\n\n  group ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"nodes"')," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    task ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"plugin"')," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"driver")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"docker"'),"\n\n      ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"config")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"image")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"amazon/aws-efs-csi-driver:latest"'),"\n\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"args")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"["),"\n          ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"node"'),",\n          ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"--endpoint=unix://csi/csi.sock"'),",\n          ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"--logtostderr"'),",\n          ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"--v=5"'),",\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# all CSI node plugins will need to run as privileged tasks"),"\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# so they can mount volumes to the host. controller plugins"),"\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# do not need to be privileged."),"\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"privileged")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n      ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n      ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"csi_plugin")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"id"),"        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"aws-efs0"'),"\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"type"),"      ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"node"'),"\n        ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"mount_dir")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"/csi"'),"  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# this path /csi matches the --endpoint"),"\n                            ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# argument for the container"),"\n      ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n  ",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")))}j.isMDXComponent=!0},c0XB:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/job-specification/csi_plugin",function(){return t("Trc/")}])}},[["c0XB",0,1,2,4,3,5,6]]]);