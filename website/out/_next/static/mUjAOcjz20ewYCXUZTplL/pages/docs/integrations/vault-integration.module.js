(window.webpackJsonp=window.webpackJsonp||[]).push([[207],{"+2Et":function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return i}));var n=t("wx14"),c=t("Ff2n"),s=t("q1tI"),o=t.n(s),b=t("7ljp"),r=t("j1un"),l=(o.a.createElement,{}),p=Object(r.a)({layout:"docs",page_title:"Vault Integration",sidebar_title:"Vault Integration",description:"Learn how to integrate Nomad with HashiCorp Vault and retrieve Vault tokens for\ntasks.",__resourcePath:"docs/integrations/vault-integration.mdx",__scans:{}});function i(e){var{components:a}=e,t=Object(c.a)(e,["components"]);return Object(b.b)(p,Object(n.a)({},l,t,{components:a,mdxType:"MDXLayout"}),Object(b.b)("h1",{className:"g-type-display-2"},Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__permalink-h",href:"#vault-integration","aria-label":"vault integration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__target-h",id:"vault-integration","aria-hidden":""})),"Vault Integration"),Object(b.b)("p",null,"Many workloads require access to tokens, passwords, certificates, API keys, and\nother secrets. To enable secure, auditable and easy access to your secrets,\nNomad integrates with HashiCorp's ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.vaultproject.io/",title:"Vault by HashiCorp"}),"Vault"),". Nomad servers and clients\ncoordinate with Vault to derive a Vault token that has access to only the Vault\npolicies the tasks needs. Nomad clients make the token available to the task and\nhandle the tokens renewal. Further, Nomad's ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/job-specification/template",title:"Nomad template Job Specification"}),Object(b.b)("inlineCode",{parentName:"a"},"template")," block")," can\nretrieve secrets from Vault making it easier than ever to secure your\ninfrastructure."),Object(b.b)("p",null,"Note that in order to use Vault with Nomad, you will need to configure and\ninstall Vault separately from Nomad. Nomad does not run Vault for you."),Object(b.b)("div",{className:"alert alert-info g-type-body",role:"alert"},Object(b.b)("p",{parentName:"div"},"",Object(b.b)("strong",{parentName:"p"},"Note:")," Vault integration requires Vault version 0.6.2 or higher.")),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#vault-configuration","aria-label":"vault configuration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"vault-configuration","aria-hidden":""})),"Vault Configuration"),Object(b.b)("p",null,"To use the Vault integration, Nomad servers must be provided a Vault token. This\ntoken can either be a root token or a periodic token with permissions to create\nfrom a token role. The root token is the easiest way to get started, but we\nrecommend a token role based token for production installations. Nomad servers\nwill renew the token automatically. ",Object(b.b)("strong",{parentName:"p"},"Note that the Nomad clients do not need to\nbe provided with a Vault token.")),Object(b.b)("div",{className:"alert alert-info g-type-body",role:"alert"},Object(b.b)("p",{parentName:"div"},"",Object(b.b)("strong",{parentName:"p"},"Note:")," See the ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/integrations/vault-integration#enterprise-configuration"}),"Enterprise specific section")," for configuring Vault Enterprise")),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#root-token-integration","aria-label":"root token integration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"root-token-integration","aria-hidden":""})),"Root Token Integration"),Object(b.b)("p",null,"If Nomad is given a ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/concepts/tokens#root-tokens"}),"root\ntoken"),", no\nfurther configuration is needed as Nomad can derive a token for jobs using any\nVault policies. Best practices recommend using a periodic token with the minimal\npermissions necessary instead of providing Nomad the root vault token."),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#token-role-based-integration","aria-label":"token role based integration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"token-role-based-integration","aria-hidden":""})),"Token Role based Integration"),Object(b.b)("p",null,"Vault's ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/auth/token",title:"Vault Authentication Backend"}),"Token Authentication Backend"),' supports a concept called "roles".\nToken roles allow policies to be grouped together and token creation to be\ndelegated to a trusted service such as Nomad. By creating a token role, the set\nof policies that tasks managed by Nomad can access may be limited compared to\ngiving Nomad a root token. Token roles allow both white-list and blacklist\nmanagement of policies accessible to the role.'),Object(b.b)("p",null,"To configure Nomad and Vault to create tokens against a role, the following must\noccur:"),Object(b.b)("ol",null,Object(b.b)("li",Object(n.a)({parentName:"ol"},{className:"g-type-long-body"}),Object(b.b)("p",{parentName:"li"},'Create a "nomad-server" policy used by Nomad to create and manage tokens.')),Object(b.b)("li",Object(n.a)({parentName:"ol"},{className:"g-type-long-body"}),Object(b.b)("p",{parentName:"li"},"Create a Vault token role with the configuration described below.")),Object(b.b)("li",Object(n.a)({parentName:"ol"},{className:"g-type-long-body"}),Object(b.b)("p",{parentName:"li"},"Configure Nomad to use the created token role.")),Object(b.b)("li",Object(n.a)({parentName:"ol"},{className:"g-type-long-body"}),Object(b.b)("p",{parentName:"li"},'Give Nomad servers a periodic token with the "nomad-server" policy created\nabove.'))),Object(b.b)("h4",{className:"g-type-display-5"},Object(b.b)("a",Object(n.a)({parentName:"h4"},{className:"__permalink-h",href:"#required-vault-policies","aria-label":"required vault policies permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h4"},{className:"__target-h",id:"required-vault-policies","aria-hidden":""})),"Required Vault Policies"),Object(b.b)("p",null,"The token Nomad receives must have the capabilities listed below. An explanation\nfor the use of each capability is given."),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),'# Allow creating tokens under "nomad-cluster" token role. The token role name'),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),'# should be updated if "nomad-cluster" is not used.'),"\npath ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"auth/token/create/nomad-cluster"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"update"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),'# Allow looking up "nomad-cluster" token role. The token role name should be'),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),'# updated if "nomad-cluster" is not used.'),"\npath ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"auth/token/roles/nomad-cluster"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"read"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# Allow looking up the token passed to Nomad to validate # the token has the"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),'# proper capabilities. This is provided by the "default" policy.'),"\npath ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"auth/token/lookup-self"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"read"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# Allow looking up incoming tokens to validate they have permissions to access"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# the tokens they are requesting. This is only required if"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# `allow_unauthenticated` is set to false."),"\npath ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"auth/token/lookup"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"update"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# Allow revoking tokens that should no longer exist. This allows revoking"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# tokens for dead tasks."),"\npath ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"auth/token/revoke-accessor"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"update"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# Allow checking the capabilities of our own token. This is used to validate the"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# token upon startup."),"\npath ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"sys/capabilities-self"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"update"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# Allow our own token to be renewed."),"\npath ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"auth/token/renew-self"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"update"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"The above ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/data/vault/nomad-server-policy.hcl"}),Object(b.b)("inlineCode",{parentName:"a"},"nomad-server")," policy")," is\navailable for download. Below is an example of writing this policy to Vault:"),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"# Download the policy\n"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"curl")," https://nomadproject.io/data/vault/nomad-server-policy.hcl -O -s -L")),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"# Write the policy to Vault\n"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault policy ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"write")," nomad-server nomad-server-policy.hcl")),"\n")),Object(b.b)("h4",{className:"g-type-display-5"},Object(b.b)("a",Object(n.a)({parentName:"h4"},{className:"__permalink-h",href:"#vault-token-role-configuration","aria-label":"vault token role configuration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h4"},{className:"__target-h",id:"vault-token-role-configuration","aria-hidden":""})),"Vault Token Role Configuration"),Object(b.b)("p",null,"A Vault token role must be created for use by Nomad. The token role can be used\nto manage what Vault policies are accessible by jobs submitted to Nomad. The\npolicies can be managed as a whitelist by using ",Object(b.b)("inlineCode",{parentName:"p"},"allowed_policies")," in the token\nrole definition or as a blacklist by using ",Object(b.b)("inlineCode",{parentName:"p"},"disallowed_policies"),"."),Object(b.b)("p",null,"If using ",Object(b.b)("inlineCode",{parentName:"p"},"allowed_policies"),", tasks may only request Vault policies that are in\nthe list. If ",Object(b.b)("inlineCode",{parentName:"p"},"disallowed_policies")," is used, task may request any policy that is\nnot in the ",Object(b.b)("inlineCode",{parentName:"p"},"disallowed_policies")," list. There are trade-offs to both approaches\nbut generally it is easier to use the blacklist approach and add policies that\nyou would not like tasks to have access to into the ",Object(b.b)("inlineCode",{parentName:"p"},"disallowed_policies")," list."),Object(b.b)("p",null,"An example token role definition is given below:"),Object(b.b)("pre",{className:"language-json"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-json"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),'"disallowed_policies"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token operator"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"nomad-server"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),'"token_explicit_max_ttl"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token operator"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"0"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),'"name"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token operator"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"nomad-cluster"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),'"orphan"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token operator"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token boolean"}),"true"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),'"token_period"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token operator"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token number"}),"259200"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),'"renewable"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token operator"}),":")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("h5",{className:"g-type-display-6"},Object(b.b)("a",Object(n.a)({parentName:"h5"},{className:"__permalink-h",href:"#token-role-requirements","aria-label":"token role requirements permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h5"},{className:"__target-h",id:"token-role-requirements","aria-hidden":""})),"Token Role Requirements"),Object(b.b)("p",null,"Nomad checks that token role has an appropriate configuration for use by the\ncluster. Fields that are checked are documented below as well as descriptions of\nthe important fields. See Vault's ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/auth/token",title:"Vault Authentication Backend"}),"Token Authentication Backend"),"\ndocumentation for all possible fields and more complete documentation."),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"allowed_policies",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#allowed_policies","aria-label":"allowed_policies permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"allowed_policies"))," - Specifies the list of allowed policies as a\ncomma-separated string. This list should contain all policies that jobs running\nunder Nomad should have access to.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"disallowed_policies",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#disallowed_policies","aria-label":"disallowed_policies permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"disallowed_policies"))," - Specifies the list of disallowed policies as a\ncomma-separated string. This list should contain all policies that jobs running\nunder Nomad should ",Object(b.b)("strong",{parentName:"p"},"not")," have access to. The policy created above that\ngrants Nomad the ability to generate tokens from the token role should be\nincluded in list of disallowed policies. This prevents tokens created by\nNomad from generating new tokens with different policies than those granted\nby Nomad."),Object(b.b)("p",{parentName:"li"},"A regression occurred in Vault 0.6.4 when validating token creation using a\ntoken role with ",Object(b.b)("inlineCode",{parentName:"p"},"disallowed_policies")," such that it is not usable with\nNomad. This was remedied in 0.6.5 and does not effect earlier versions\nof Vault.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"token_explicit_max_ttl",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#token_explicit_max_ttl","aria-label":"token_explicit_max_ttl permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"token_explicit_max_ttl"))," - Specifies the max TTL of a token. ",Object(b.b)("strong",{parentName:"p"},"Must be set to ",Object(b.b)("inlineCode",{parentName:"strong"},"0"))," to\nallow periodic tokens.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"name",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#name","aria-label":"name permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"name"))," - Specifies the name of the policy. We recommend using the name\n",Object(b.b)("inlineCode",{parentName:"p"},"nomad-cluster"),". If a different name is chosen, replace the token role in the\nabove policy.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"orphan",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#orphan","aria-label":"orphan permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"orphan"))," - Specifies whether tokens created against this token role will be\norphaned and have no parents. Nomad does not enforce the value of this field\nbut understanding the implications of each value is important."),Object(b.b)("p",{parentName:"li"},"If set to false, all tokens will be revoked when the Vault token given to\nNomad expires. This makes it easy to revoke all tokens generated by Nomad but\nforces all Nomad servers to use the same Vault token, even through upgrades of\nNomad servers. If the Vault token that was given to Nomad and used to generate\na tasks token expires, the token used by the task will also be revoked which\nis not ideal."),Object(b.b)("p",{parentName:"li"},"When set to true, the tokens generated for tasks will not be revoked when\nNomad's token is revoked. However Nomad will still revoke tokens when the\nallocation is no longer running, minimizing the lifetime of any task's token.\nWith orphaned enabled, each Nomad server may also use a unique Vault token,\nmaking bootstrapping and upgrading simpler. As such, ",Object(b.b)("strong",{parentName:"p"},"setting ",Object(b.b)("inlineCode",{parentName:"strong"},"orphan = true"),"\nis the recommended setting"),".")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"token_period",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#token_period","aria-label":"token_period permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"token_period"))," - Specifies the length the TTL is extended by each renewal in\nseconds. It is suggested to set this value on the order of magnitude of 3 days\n(259200 seconds) to avoid a large renewal request rate to Vault. ",Object(b.b)("strong",{parentName:"p"},"Must be set\nto a positive value"),".")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"renewable",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#renewable","aria-label":"renewable permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"renewable"))," - Specifies whether created tokens are renewable. ",Object(b.b)("strong",{parentName:"p"},"Must be set to\n",Object(b.b)("inlineCode",{parentName:"strong"},"true")),". This allows Nomad to renew tokens for tasks."))),Object(b.b)("p",null,"The above ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/data/vault/nomad-cluster-role.json"}),Object(b.b)("inlineCode",{parentName:"a"},"nomad-cluster")," token role")," is\navailable for download. Below is an example of writing this role to Vault:"),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"# Download the token role\n"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"curl")," https://nomadproject.io/data/vault/nomad-cluster-role.json -O -s -L")),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"# Create the token role with Vault\n"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"write")," /auth/token/roles/nomad-cluster @nomad-cluster-role.json")),"\n")),Object(b.b)("h4",{className:"g-type-display-5"},Object(b.b)("a",Object(n.a)({parentName:"h4"},{className:"__permalink-h",href:"#example-configuration","aria-label":"example configuration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h4"},{className:"__target-h",id:"example-configuration","aria-hidden":""})),"Example Configuration"),Object(b.b)("p",null,"To make getting started easy, the basic ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/data/vault/nomad-server-policy.hcl"}),Object(b.b)("inlineCode",{parentName:"a"},"nomad-server"),"\npolicy")," and\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/data/vault/nomad-cluster-role.json"}),Object(b.b)("inlineCode",{parentName:"a"},"nomad-cluster")," role")," described above are\navailable for download."),Object(b.b)("p",null,"The below example assumes Vault is accessible, unsealed and the operator has\nappropriate permissions."),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"# Download the policy and token role\n"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"curl")," https://nomadproject.io/data/vault/nomad-server-policy.hcl -O -s -L")),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"curl")," https://nomadproject.io/data/vault/nomad-cluster-role.json -O -s -L")),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"# Write the policy to Vault\n"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault policy ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"write")," nomad-server nomad-server-policy.hcl")),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"# Create the token role with Vault\n"),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"write")," /auth/token/roles/nomad-cluster @nomad-cluster-role.json")),"\n")),Object(b.b)("h4",{className:"g-type-display-5"},Object(b.b)("a",Object(n.a)({parentName:"h4"},{className:"__permalink-h",href:"#retrieving-the-token-role-based-token","aria-label":"retrieving the token role based token permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h4"},{className:"__target-h",id:"retrieving-the-token-role-based-token","aria-hidden":""})),"Retrieving the Token Role based Token"),Object(b.b)("p",null,"After the token role is created, a token suitable for the Nomad servers may be\nretrieved by issuing the following Vault command:"),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault token create -policy nomad-server -period 72h -orphan")),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"Key             Value\n---             -----\ntoken           f02f01c2-c0d1-7cb7-6b88-8a14fada58c0\ntoken_accessor  8cb7fcb3-9a4f-6fbf-0efc-83092bb0cb1c\ntoken_duration  259200s\ntoken_renewable true\ntoken_policies  [default nomad-server]\n"))),Object(b.b)("p",null,"The ",Object(b.b)("inlineCode",{parentName:"p"},"-orphan")," flag is included when generating the Nomad server token above to\nprevent revocation of the token when its parent expires. Vault typically\ncreates tokens with a parent-child relationship. When an ancestor token is\nrevoked, all of its descendant tokens and their associated leases are revoked\nas well."),Object(b.b)("p",null,"When generating Nomad's Vault token, we need to ensure that revocation of the\nparent token does not revoke Nomad's token. To prevent this behavior we\nspecify the ",Object(b.b)("inlineCode",{parentName:"p"},"-orphan")," flag when we create the Nomad's Vault token. All\nother tokens generated by Nomad for jobs will be generated using the policy\ndefault of ",Object(b.b)("inlineCode",{parentName:"p"},"orphan = false"),"."),Object(b.b)("p",null,"More information about creating orphan tokens can be found in\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/concepts/tokens#token-hierarchies-and-orphan-tokens",title:"Vault Tokens - Token Hierarchies and Orphan Tokens"}),"Vault's Token Hierarchies and Orphan Tokens documentation"),"."),Object(b.b)("p",null,"The token can then be set in the server configuration's\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration/vault",title:"Nomad Vault Configuration Block"}),Object(b.b)("inlineCode",{parentName:"a"},"vault")," stanza"),", as a command-line flag, or via an environment\nvariable."),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token assign-left variable"}),"VAULT_TOKEN"),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),"="),"f02f01c2-c0d1-7cb7-6b88-8a14fada58c0 nomad agent -config /path/to/config")),"\n")),Object(b.b)("p",null,"An example of what may be contained in the configuration is shown below. For\ncomplete documentation please see the ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration/vault",title:"Nomad Vault Configuration Block"}),"Nomad agent Vault integration"),"\nconfiguration."),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"enabled"),"          ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"ca_path"),"          ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/etc/certs/ca"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"cert_file"),"        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/var/certs/vault.crt"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"key_file"),"         ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/var/certs/vault.key"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"address"),"          ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"https://vault.service.consul:8200"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"create_from_role")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"nomad-cluster"'),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#agent-configuration","aria-label":"agent configuration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"agent-configuration","aria-hidden":""})),"Agent Configuration"),Object(b.b)("p",null,"To enable Vault integration, please see the ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration/vault",title:"Nomad Vault Configuration Block"}),"Nomad agent Vault\nintegration")," configuration."),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#vault-definition-syntax","aria-label":"vault definition syntax permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"vault-definition-syntax","aria-hidden":""})),"Vault Definition Syntax"),Object(b.b)("p",null,"To configure a job to retrieve Vault tokens, please see the ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/job-specification/vault",title:"Nomad Vault Job Specification"}),Object(b.b)("inlineCode",{parentName:"a"},"vault")," job\nspecification documentation"),"."),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#troubleshooting","aria-label":"troubleshooting permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"troubleshooting","aria-hidden":""})),"Troubleshooting"),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#invalid-vault-token","aria-label":"invalid vault token permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"invalid-vault-token","aria-hidden":""})),"Invalid Vault token"),Object(b.b)("p",null,"Upon startup, Nomad will attempt to connect to the specified Vault server. Nomad\nwill lookup the passed token and if the token is from a token role, the token\nrole will be validated. Nomad will not shutdown if given an invalid Vault token,\nbut will log the reasons the token is invalid and disable Vault integration."),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#permission-denied-errors","aria-label":"permission denied errors permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"permission-denied-errors","aria-hidden":""})),"Permission Denied errors"),Object(b.b)("p",null,"If you are using a Vault version less than 0.7.1 with a Nomad version greater than or equal to 0.6.1, you will need to update your task's policy (listed in ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/job-specification/vault",title:"Nomad Vault Job Specification"}),"the ",Object(b.b)("inlineCode",{parentName:"a"},"vault")," stanza of the job specification"),") to add the following:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"path ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"sys/leases/renew"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"update"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,'This is included in Vault\'s "default" policy beginning with Vault 0.7.1 and is relied upon by Nomad\'s Vault integration beginning with Nomad 0.6.1. If you\'re using a newer Nomad version with an older Vault version, your default policy may not automatically include this and you will see "permission denied" errors in your Nomad logs similar to the following:'),Object(b.b)("pre",{className:"language-plaintext"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-plaintext"}),"Code: 403. Errors:\nURL: PUT https://vault:8200/v1/sys/leases/renew\n* permission denied\n")),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#no-secret-exists","aria-label":"no secret exists permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"no-secret-exists","aria-hidden":""})),"No Secret Exists"),Object(b.b)("p",null,"Vault has two APIs for secrets, ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/secrets/kv",title:"KV Secrets Engine"}),Object(b.b)("inlineCode",{parentName:"a"},"v1")," and ",Object(b.b)("inlineCode",{parentName:"a"},"v2")),". Each version\nhas different paths, and Nomad does not abstract this for you. As such you will\nneed to specify the path as reflected by Vault's HTTP API, rather than the path\nused in the ",Object(b.b)("inlineCode",{parentName:"p"},"vault kv")," command."),Object(b.b)("p",null,"You can see examples of ",Object(b.b)("inlineCode",{parentName:"p"},"v1")," and ",Object(b.b)("inlineCode",{parentName:"p"},"v2")," syntax in the\n",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/job-specification/template#vault-kv-api-v1",title:"Vault KV API v1"}),"template documentation"),"."),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#enterprise-configuration","aria-label":"enterprise configuration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"enterprise-configuration","aria-hidden":""})),"Enterprise Configuration"),Object(b.b)("p",null,"Nomad Enterprise 0.12.2 introduced the ability for jobs to use multiple Vault Namespaces.\nThere are a few configuration settings to consider when using this functionality."),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#example-configuration-1","aria-label":"example configuration permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"example-configuration-1","aria-hidden":""})),"Example Configuration"),Object(b.b)("p",null,"Below is an example for creating two Namespaces within Vault."),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),'# Create a namespace "engineering" within Vault\n'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault namespace create engineering")),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),'# Create a child namespace "frontend" under "engineering"\n'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault namespace create -namespace",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),"="),"engineering frontend")),"\n")),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#required-vault-policies-1","aria-label":"required vault policies permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"required-vault-policies-1","aria-hidden":""})),"Required Vault Policies"),Object(b.b)("p",null,"Policies are configured per Vault namespace. We will apply the policy in the example above to each namespace\u2014engineering and engineering/frontend."),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),'# Create the "nomad-server" policy in the "engineering" namespace\n'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault policy ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"write")," -namespace",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),"="),"engineering nomad-server nomad-server-policy.hcl")),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),'# Create the "nomad-server" policy in the "engineering/frontend" namespace\n'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault policy ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"write")," -namespace",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),"="),"engineering/frontend nomad-server nomad-server-policy.hcl")),"\n")),Object(b.b)("p",null,"We will also configure the previously configured ",Object(b.b)("inlineCode",{parentName:"p"},"nomad-cluster")," role with each Namespace"),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),'# Create the "nomad-cluster" token role in the "engineering" namespace\n'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"write")," -namespace",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),"="),"engineering /auth/token/roles/nomad-cluster @nomad-cluster-role.json")),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),'# Create the "nomad-cluster" token role in the "engineering/frontend" namespace\n'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token function"}),"write")," -namespace",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),"="),"engineering/frontend /auth/token/roles/nomad-cluster @nomad-cluster-role.json")),"\n")),Object(b.b)("p",null,"The ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration/vault",title:"Nomad Vault Configuration Block"}),"Nomad agent Vault integration")," configuration supports specifying a Vault Namespace, but since\nwe will be using multiple it can be left blank. By default Nomad will interact with Vault's root Namespace, but individual jobs may specify other Vault Namespaces to use."),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"enabled"),"               ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"ca_path"),"               ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/etc/certs/ca"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"cert_file"),"             ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/var/certs/vault.crt"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"key_file"),"              ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/var/certs/vault.key"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"address"),"               ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"https://vault.service.consul:8200"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"create_from_role"),"      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"nomad-cluster"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"allow_unauthenticated")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token boolean"}),"false")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token comment"}),"# Disabling allow_unauthenticated is a best practice for securing your cluster"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"The same steps can be taken to inject a Vault token from the ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#retrieving-the-token-role-based-token"}),"Retrieving the Token Role based Token")," steps."),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#submitting-a-job-with-a-vault-namespace","aria-label":"submitting a job with a vault namespace permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"submitting-a-job-with-a-vault-namespace","aria-hidden":""})),"Submitting a job with a Vault Namespace"),Object(b.b)("p",null,"Since ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration/vault#allow_unauthenticated"}),Object(b.b)("inlineCode",{parentName:"a"},"allow_unauthenticated"))," is set to ",Object(b.b)("inlineCode",{parentName:"p"},"false")," job submitters will need to provide a sufficiently privileged token when submitting a job."),Object(b.b)("p",null,"The example job file below specifies to use the ",Object(b.b)("inlineCode",{parentName:"p"},"engineering")," Namespace in Vault. It will then read the value at secret/foo and fetch the value for key ",Object(b.b)("inlineCode",{parentName:"p"},"bar")),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"job ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"vault"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"datacenters")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"dc1"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n\n  group ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"demo"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    task ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"task"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"namespace")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"engineering"'),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"policies"),"  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"access-kv"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"driver")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"raw_exec"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"config")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"command")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"/usr/bin/cat"'),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"args"),"    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"secrets/config.txt"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"data"),"        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOF\n{{ with secret "secret/foo" }}\nSOME_VAL={{.Data.bar}}\n{{ end }}\nEOF'),"\n        ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"destination")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"secrets/config.txt"'),"\n      ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n")),Object(b.b)("p",null,"To Submit this job a token that has the ",Object(b.b)("inlineCode",{parentName:"p"},"access-kv")," policy in the Namespace ",Object(b.b)("inlineCode",{parentName:"p"},"engineering")),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"vault token create -policy access-kv -namespace",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),"="),"engineering -period 72h -oprhan")),"\n\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),'Key                  Value\n---                  -----\ntoken                s.H39hfS7eHSbb1GpkdzOQLTmz.fvuLy\ntoken_accessor       VsKtJwaShwtTo1r9nWV9Rlad.fvuLy\ntoken_duration       72h\ntoken_renewable      true\ntoken_policies       ["access-kv" "default"]\nidentity_policies    []\npolicies             ["access-kv" "default"]\n'))),Object(b.b)("p",null,"The token can then be submitted with our job"),Object(b.b)("pre",{className:"language-shell-session"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token assign-left variable"}),"VAULT_TOKEN"),Object(b.b)("span",Object(n.a)({parentName:"span"},{className:"token operator"}),"="),"s.H39hfS7eHSbb1GpkdzOQLTmz.fvuLy nomad job run vault.nomad")),"\n")))}i.isMDXComponent=!0},xqnC:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/integrations/vault-integration",function(){return t("+2Et")}])}},[["xqnC",0,1,2,4,3,5,6]]]);