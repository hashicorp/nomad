(window.webpackJsonp=window.webpackJsonp||[]).push([[254],{kGq8:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return O}));var n,c=t("wx14"),s=t("Ff2n"),b=t("q1tI"),p=t.n(b),r=t("7ljp"),i=t("j1un"),l=(p.a.createElement,n="Placement",function(e){return console.warn("Component "+n+" was not imported, exported, or provided by MDXProvider as global scope"),Object(r.b)("div",e)}),o={},m=Object(i.a)({layout:"docs",page_title:"template Stanza - Job Specification",sidebar_title:"template",description:'The "template" block instantiates an instance of a template renderer. This\ncreates a convenient way to ship configuration files that are populated from\nenvironment variables, Consul data, Vault secrets, or just general\nconfigurations within a Nomad task.',__resourcePath:"docs/job-specification/template.mdx",__scans:{}});function O(e){var{components:a}=e,t=Object(s.a)(e,["components"]);return Object(r.b)(m,Object(c.a)({},o,t,{components:a,mdxType:"MDXLayout"}),Object(r.b)("h1",{className:"g-type-display-2"},Object(r.b)("a",Object(c.a)({parentName:"h1"},{className:"__permalink-h",href:"#template-stanza","aria-label":"template stanza permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h1"},{className:"__target-h",id:"template-stanza","aria-hidden":""})),Object(r.b)("inlineCode",{parentName:"h1"},"template")," Stanza"),Object(r.b)(l,{groups:["job","group","task","template"],mdxType:"Placement"}),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"template")," block instantiates an instance of a template renderer. This\ncreates a convenient way to ship configuration files that are populated from\nenvironment variables, Consul data, Vault secrets, or just general\nconfigurations within a Nomad task."),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),"job ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"docs"')," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  group ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"example"')," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    task ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"server"')," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"source"),"        ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"local/redis.conf.tpl"'),"\n        ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"local/redis.conf"'),"\n        ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"change_mode"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"signal"'),"\n        ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"change_signal")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"SIGINT"'),"\n      ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("p",null,"Nomad utilizes a tool called ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://github.com/hashicorp/consul-template",title:"Consul Template by HashiCorp"}),"Consul Template"),". Since Nomad v0.5.3, the\ntemplate can reference ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/runtime/environment",title:"Nomad Runtime Environment"}),"Nomad's runtime environment variables"),". Since Nomad\nv0.5.6, the template can reference ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/runtime/interpolation#interpreted_node_vars",title:"Nomad Node Variables"}),"Node attributes and metadata"),". For\na full list of the API template functions, please refer to the ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://github.com/hashicorp/consul-template",title:"Consul Template by HashiCorp"}),"Consul Template\nREADME"),". Since Nomad v0.6.0, templates can be read as environment variables."),Object(r.b)("h2",{className:"g-type-display-3"},Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#template-parameters","aria-label":"template parameters permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"template-parameters","aria-hidden":""})),Object(r.b)("inlineCode",{parentName:"h2"},"template")," Parameters"),Object(r.b)("ul",null,Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"change_mode",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#change_mode","aria-label":"change_mode permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"change_mode"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "restart")')," - Specifies the behavior Nomad should take\nif the rendered template changes. Nomad will always write the new contents of\nthe template to the specified destination. The possible values below describe\nNomad's action after writing the template to disk."),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"noop",className:"__target-lic","aria-hidden":""})),Object(r.b)("a",Object(c.a)({parentName:"li"},{href:"#noop","aria-label":"noop permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},'"noop"'))," - take no action (continue running the task)"),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"restart",className:"__target-lic","aria-hidden":""})),Object(r.b)("a",Object(c.a)({parentName:"li"},{href:"#restart","aria-label":"restart permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},'"restart"'))," - restart the task"),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"signal",className:"__target-lic","aria-hidden":""})),Object(r.b)("a",Object(c.a)({parentName:"li"},{href:"#signal","aria-label":"signal permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},'"signal"'))," - send a configurable signal to the task"))),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"change_signal",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#change_signal","aria-label":"change_signal permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"change_signal"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies the signal to send to the task as a\nstring like ",Object(r.b)("inlineCode",{parentName:"p"},'"SIGUSR1"')," or ",Object(r.b)("inlineCode",{parentName:"p"},'"SIGINT"'),". This option is required if the\n",Object(r.b)("inlineCode",{parentName:"p"},"change_mode")," is ",Object(r.b)("inlineCode",{parentName:"p"},"signal"),".")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"data",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#data","aria-label":"data permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"data"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies the raw template to execute. One of ",Object(r.b)("inlineCode",{parentName:"p"},"source"),"\nor ",Object(r.b)("inlineCode",{parentName:"p"},"data")," must be specified, but not both. This is useful for smaller\ntemplates, but we recommend using ",Object(r.b)("inlineCode",{parentName:"p"},"source")," for larger templates.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"destination",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#destination","aria-label":"destination permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"destination"))," ",Object(r.b)("inlineCode",{parentName:"p"},"(string: <required>)")," - Specifies the location where the\nresulting template should be rendered, relative to the task directory.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"env",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#env","aria-label":"env permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"env"))," ",Object(r.b)("inlineCode",{parentName:"p"},"(bool: false)")," - Specifies the template should be read back in as\nenvironment variables for the task. (",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#environment-variables"}),"See below"),")")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"left_delimiter",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#left_delimiter","aria-label":"left_delimiter permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"left_delimiter"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "{{")'),' - Specifies the left delimiter to use in the\ntemplate. The default is "{{" for some templates, it may be easier to use a\ndifferent delimiter that does not conflict with the output file itself.')),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"perms",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#perms","aria-label":"perms permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"perms"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "644")')," - Specifies the rendered template's permissions.\nFile permissions are given as octal of the Unix file permissions ",Object(r.b)("inlineCode",{parentName:"p"},"rwxrwxrwx"),".")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"right_delimiter",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#right_delimiter","aria-label":"right_delimiter permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"right_delimiter"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "}}")'),' - Specifies the right delimiter to use in the\ntemplate. The default is "}}" for some templates, it may be easier to use a\ndifferent delimiter that does not conflict with the output file itself.')),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"source",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#source","aria-label":"source permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"source"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies the path to the template to be rendered.\nOne of ",Object(r.b)("inlineCode",{parentName:"p"},"source")," or ",Object(r.b)("inlineCode",{parentName:"p"},"data")," must be specified, but not both. This source can\noptionally be fetched using an ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/job-specification/artifact",title:"Nomad artifact Job Specification"}),Object(r.b)("inlineCode",{parentName:"a"},"artifact"))," resource. This template\nmust exist on the machine prior to starting the task; it is not possible to\nreference a template inside of a Docker container, for example.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"splay",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#splay","aria-label":"splay permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"splay"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "5s")'),' - Specifies a random amount of time to wait between\n0 ms and the given splay value before invoking the change mode. This is\nspecified using a label suffix like "30s" or "1h", and is often used to\nprevent a thundering herd problem where all task instances restart at the same\ntime.')),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"vault_grace",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#vault_grace","aria-label":"vault_grace permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"vault_grace"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "15s")')," - ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://github.com/hashicorp/consul-template/issues/1268"}),"Deprecated")))),Object(r.b)("h2",{className:"g-type-display-3"},Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#template-examples","aria-label":"template examples permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"template-examples","aria-hidden":""})),Object(r.b)("inlineCode",{parentName:"h2"},"template")," Examples"),Object(r.b)("p",null,"The following examples only show the ",Object(r.b)("inlineCode",{parentName:"p"},"template")," stanzas. Remember that the\n",Object(r.b)("inlineCode",{parentName:"p"},"template")," stanza is only valid in the placements listed above."),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#inline-template","aria-label":"inline template permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"inline-template","aria-hidden":""})),"Inline Template"),Object(r.b)("p",null,"This example uses an inline template to render a file to disk. This file watches\nvarious keys in Consul for changes:"),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data"),"        ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"---\\nkey: {{ key \\"service/my-key\\" }}"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"local/file.yml"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("p",null,"It is also possible to use heredocs for multi-line templates, like:"),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOH\n  ---\n    bind_port:   {{ env "NOMAD_PORT_db" }}\n    scratch_dir: {{ env "NOMAD_TASK_DIR" }}\n    node_id:     {{ env "node.unique.id" }}\n    service_key: {{ key "service/my-key" }}\n  EOH'),"\n\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"local/file.yml"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#remote-template","aria-label":"remote template permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"remote-template","aria-hidden":""})),"Remote Template"),Object(r.b)("p",null,"This example uses an ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/job-specification/artifact",title:"Nomad artifact Job Specification"}),Object(r.b)("inlineCode",{parentName:"a"},"artifact"))," stanza to download an input template\nbefore passing it to the template engine:"),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"artifact")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"source"),"      ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"https://example.com/file.yml.tpl"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"local/file.yml.tpl"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"source"),"      ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"local/file.yml.tpl"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"local/file.yml"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#node-variables","aria-label":"node variables permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"node-variables","aria-hidden":""})),"Node Variables"),Object(r.b)("p",null,"As of Nomad v0.5.6 it is possible to access the Node's attributes and metadata."),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOH\n  ---\n    node_dc:    {{ env "node.datacenter" }}\n    node_cores: {{ env "attr.cpu.numcores" }}\n    meta_key:   {{ env "meta.node_meta_key" }}\n  EOH'),"\n\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"local/file.yml"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#environment-variables","aria-label":"environment variables permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"environment-variables","aria-hidden":""})),"Environment Variables"),Object(r.b)("p",null,"Since v0.6.0 templates may be used to create environment variables for tasks.\nEnv templates work exactly like other templates except once the templates are\nwritten, they are parsed as ",Object(r.b)("inlineCode",{parentName:"p"},"KEY=value")," pairs. Those key value pairs are\nincluded in the task's environment."),Object(r.b)("p",null,"For example the following template stanza:"),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOH\n# Lines starting with a # are ignored\n\n# Empty lines are also ignored\nLOG_LEVEL="{{key "service/geo-api/log-verbosity"}}"\nAPI_KEY="{{with secret "secret/geo-api-key"}}{{.Data.value}}{{end}}"\nEOH'),"\n\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"secrets/file.env"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"env"),"         ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("p",null,"The task's environment would then have environment variables like the\nfollowing:"),Object(r.b)("pre",null,Object(r.b)("code",Object(c.a)({parentName:"pre"},{}),"LOG_LEVEL=DEBUG\nAPI_KEY=12345678-1234-1234-1234-1234-123456789abc\n")),Object(r.b)("p",null,"This allows ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://12factor.net/config"}),"12factor app")," style environment\nvariable based configuration while keeping all of the familiar features and\nsemantics of Nomad templates."),Object(r.b)("p",null,"Secrets or certificates may contain a wide variety of characters such as\nnewlines, quotes, and backslashes which may be difficult to quote or escape\nproperly."),Object(r.b)("p",null,"Whenever a templated variable may include special characters, use the ",Object(r.b)("inlineCode",{parentName:"p"},"toJSON"),"\nfunction to ensure special characters are properly parsed by Nomad:"),Object(r.b)("pre",null,Object(r.b)("code",Object(c.a)({parentName:"pre"},{}),'CERT_PEM={{ file "path/to/cert.pem" | toJSON }}\n')),Object(r.b)("p",null,"The parser will read the JSON string, so the ",Object(r.b)("inlineCode",{parentName:"p"},"$CERT_PEM")," environment variable\nwill be identical to the contents of the file."),Object(r.b)("p",null,"Likewise when evaluating a password that may contain quotes or ",Object(r.b)("inlineCode",{parentName:"p"},"#"),", use the\n",Object(r.b)("inlineCode",{parentName:"p"},"toJSON")," function to ensure Nomad passes the password to task unchanged:"),Object(r.b)("pre",null,Object(r.b)("code",Object(c.a)({parentName:"pre"},{}),'# Passwords may contain any character including special characters like:\n#   \\"\'#\n# Use toJSON to ensure Nomad passes them to the environment unchanged.\n{{ with secret "secrets/data/application/backend" }}\nDB_PASSWD={{ .Data.data.DB_PASSWD | toJSON }}\n{{ end }}\n')),Object(r.b)("p",null,"For more details see ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://github.com/hashicorp/go-envparse#readme",title:"The go-envparse Readme"}),"go-envparser's README"),"."),Object(r.b)("h2",{className:"g-type-display-3"},Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#vault-integration","aria-label":"vault integration permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"vault-integration","aria-hidden":""})),"Vault Integration"),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#pki-certificate","aria-label":"pki certificate permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"pki-certificate","aria-hidden":""})),"PKI Certificate"),Object(r.b)("p",null,"Vault is a popular open source tool for managing secrets. In addition to acting\nas an encrypted KV store, Vault can also generate dynamic secrets, like PKI/TLS\ncertificates."),Object(r.b)("p",null,"When generating PKI certificates with Vault, the certificate, private key, and\nany intermediate certs are all returned as part of the same API call. Most\nsoftware requires these files be placed in separate files on the system."),Object(r.b)("div",{className:"alert alert-warning g-type-body",role:"alert"},Object(r.b)("p",{parentName:"div"},"",Object(r.b)("strong",{parentName:"p"},"Note"),": ",Object(r.b)("inlineCode",{parentName:"p"},"generate_lease")," must be set to ",Object(r.b)("inlineCode",{parentName:"p"},"true")," (non-default) on the Vault PKI\nrole.",Object(r.b)("br",null),Object(r.b)("br",null)," Failure to do so will cause the template to frequently render a new\ncertificate, approximately every minute. This creates a significant number of\ncertificates to be expired in Vault and could ultimately lead to Vault performance\nimpacts and failures.")),Object(r.b)("h4",{className:"g-type-display-5"},Object(r.b)("a",Object(c.a)({parentName:"h4"},{className:"__permalink-h",href:"#as-individual-files","aria-label":"as individual files permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h4"},{className:"__target-h",id:"as-individual-files","aria-hidden":""})),"As individual files"),Object(r.b)("p",null,"For templates, all dependencies are mapped into a single list. This means that\nmultiple templates watching the same path return the same data."),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOH\n{{ with secret "pki/issue/foo" "common_name=foo.service.consul" "ip_sans=127.0.0.1" }}\n{{- .Data.certificate -}}\n{{ end }}\nEOH'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"',Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token interpolation"}),Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"$"),Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"{"),"NOMAD_SECRETS_DIR",Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"}")),'/certificate.crt"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"change_mode"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"restart"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOH\n{{ with secret "pki/issue/foo" "common_name=foo.service.consul" "ip_sans=127.0.0.1" }}\n{{- .Data.issuing_ca -}}\n{{ end }}\nEOH'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"',Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token interpolation"}),Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"$"),Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"{"),"NOMAD_SECRETS_DIR",Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"}")),'/ca.crt"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"change_mode"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"restart"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOH\n{{ with secret "pki/issue/foo" "common_name=foo.service.consul" "ip_sans=127.0.0.1" }}\n{{- .Data.private_key -}}\n{{ end }}\nEOH'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"',Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token interpolation"}),Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"$"),Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"{"),"NOMAD_SECRETS_DIR",Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"}")),'/private_key.key"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"change_mode"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"restart"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("p",null,"These are three different input templates, but when run under the Nomad job,\nthey are compressed into a single call, sharing the resulting data."),Object(r.b)("h4",{className:"g-type-display-5"},Object(r.b)("a",Object(c.a)({parentName:"h4"},{className:"__permalink-h",href:"#as-a-pem-formatted-file","aria-label":"as a pem formatted file permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h4"},{className:"__target-h",id:"as-a-pem-formatted-file","aria-hidden":""})),"As a PEM formatted file"),Object(r.b)("p",null,"This example acquires a PKI certificate from Vault in PEM format, concatenates\nthe elements into a bundle, and stores it into your application's secret\ndirectory."),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOH\n{{ with secret "pki/issue/foo" "common_name=foo.service.consul" "ip_sans=127.0.0.1" "format=pem" }}\n{{ .Data.certificate }}\n{{ .Data.issuing_ca }}\n{{ .Data.private_key }}{{ end }}\nEOH'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"destination"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"',Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token interpolation"}),Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"$"),Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"{"),"NOMAD_SECRETS_DIR",Object(r.b)("span",Object(c.a)({parentName:"span"},{className:"token punctuation"}),"}")),'/bundle.pem"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"change_mode"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"restart"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#vault-kv-api-v1","aria-label":"vault kv api v1 permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"vault-kv-api-v1","aria-hidden":""})),"Vault KV API v1"),Object(r.b)("p",null,"Under Vault KV API v1, paths start with ",Object(r.b)("inlineCode",{parentName:"p"},"secret/"),", and the response returns the\nraw key/value data. This secret was set using\n",Object(r.b)("inlineCode",{parentName:"p"},"vault kv put secret/aws/s3 aws_access_key_id=somekeyid"),"."),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),"  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOF\n      AWS_ACCESS_KEY_ID = "{{with secret "secret/aws/s3"}}{{.Data.aws_access_key_id}}{{end}}"\n    EOF'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#vault-kv-api-v2","aria-label":"vault kv api v2 permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"vault-kv-api-v2","aria-hidden":""})),"Vault KV API v2"),Object(r.b)("p",null,"Under Vault KV API v2, paths start with ",Object(r.b)("inlineCode",{parentName:"p"},"secret/data/"),", and the response returns\nmetadata in addition to key/value data. This secret was set using\n",Object(r.b)("inlineCode",{parentName:"p"},"vault kv put secret/aws/s3 aws_access_key_id=somekeyid"),"."),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),"  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"template")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"data")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token heredoc string"}),'<<EOF\n      AWS_ACCESS_KEY_ID = "{{with secret "secret/data/aws/s3"}}{{.Data.data.aws_access_key_id}}{{end}}"\n    EOF'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("p",null,"Notice the addition of ",Object(r.b)("inlineCode",{parentName:"p"},"data")," in both the path and the field accessor string.\nAdditionally, when using the Vault v2 API, the Vault policies applied to your\nNomad jobs will need to grant permissions to ",Object(r.b)("inlineCode",{parentName:"p"},"read")," under ",Object(r.b)("inlineCode",{parentName:"p"},"secret/data/..."),"\nrather than ",Object(r.b)("inlineCode",{parentName:"p"},"secret/..."),"."),Object(r.b)("h2",{className:"g-type-display-3"},Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#client-configuration","aria-label":"client configuration permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"client-configuration","aria-hidden":""})),"Client Configuration"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"template")," block has the following ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/configuration/client#options"}),"client configuration\noptions"),":"),Object(r.b)("ul",null,Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"template-allow_host_source",className:"__target-lic","aria-hidden":""})),Object(r.b)("a",Object(c.a)({parentName:"li"},{href:"#template-allow_host_source","aria-label":"template allow_host_source permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"template.allow_host_source"))," - Allows templates to specify their source\ntemplate as an absolute path referencing host directories. Defaults to ",Object(r.b)("inlineCode",{parentName:"li"},"true"),".")))}O.isMDXComponent=!0},zEGF:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/job-specification/template",function(){return t("kGq8")}])}},[["zEGF",0,1,2,4,3,5,6]]]);