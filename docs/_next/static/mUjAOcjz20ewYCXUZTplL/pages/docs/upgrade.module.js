(window.webpackJsonp=window.webpackJsonp||[]).push([[266],{OET8:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return p}));var n=t("wx14"),r=t("Ff2n"),s=t("q1tI"),o=t.n(s),i=t("7ljp"),c=t("j1un"),l=(o.a.createElement,{}),b=Object(c.a)({layout:"docs",page_title:"Upgrading",sidebar_current:"guides-upgrade",description:"Learn how to upgrade Nomad.",__resourcePath:"docs/upgrade/index.mdx",__scans:{}});function p(e){var{components:a}=e,t=Object(r.a)(e,["components"]);return Object(i.b)(b,Object(n.a)({},l,t,{components:a,mdxType:"MDXLayout"}),Object(i.b)("h1",{className:"g-type-display-2"},Object(i.b)("a",Object(n.a)({parentName:"h1"},{className:"__permalink-h",href:"#upgrading","aria-label":"upgrading permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h1"},{className:"__target-h",id:"upgrading","aria-hidden":""})),"Upgrading"),Object(i.b)("p",null,"Nomad is designed to be flexible and resilient when upgrading from one Nomad\nversion to the next. Upgrades should cause neither a Nomad nor a service\noutage. However, there are some restrictions to be aware of before upgrading:"),Object(i.b)("ul",null,Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("p",{parentName:"li"},"Nomad strives to be backward compatible for at least 1 point release, so\nNomad v0.10 hosts work with v0.9 hosts. Upgrading 2 point releases (eg v0.8\nto v0.10) may work but is untested and unsupported."),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("p",{parentName:"li"},"Nomad does ",Object(i.b)("em",{parentName:"p"},"not")," support downgrading at this time. Downgrading clients\nrequires draining allocations and removing the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration#data_dir"}),"data directory"),".\nDowngrading servers safely requires re-provisioning the cluster.")),Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("p",{parentName:"li"},"New features are unlikely to work correctly until all nodes have been\nupgraded.")),Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("p",{parentName:"li"},"Check the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/upgrade/upgrade-specific"}),"version upgrade details page")," for important\nchanges and backward incompatibilities.")))),Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("p",{parentName:"li"},"When upgrading a Nomad Client, if it takes longer than the\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration/server#heartbeat_grace"}),Object(i.b)("inlineCode",{parentName:"a"},"heartbeat_grace"))," (10s by default) period to restart, all\nallocations on that node may be rescheduled."))),Object(i.b)("p",null,"Nomad supports upgrading in place or by rolling in new servers:"),Object(i.b)("ul",null,Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("p",{parentName:"li"},"In Place: The Nomad binary can be updated on existing hosts. Running\nallocations will continue running uninterrupted.")),Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("p",{parentName:"li"},"Rolling: New hosts containing the new Nomad version may be added followed by\nthe removal of old hosts. The old nodes must be drained to migrate running\nallocations to the new nodes."))),Object(i.b)("p",null,"This guide describes both approaches."),Object(i.b)("h2",{className:"g-type-display-3"},Object(i.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#upgrade-process","aria-label":"upgrade process permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"upgrade-process","aria-hidden":""})),"Upgrade Process"),Object(i.b)("p",null,"Once you have checked the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/upgrade/upgrade-specific"}),"upgrade details for the new\nversion"),", the upgrade process is as simple as updating the\nbinary on each host and restarting the Nomad service."),Object(i.b)("p",null,"At a high level we complete the following steps to upgrade Nomad:"),Object(i.b)("ul",null,Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("strong",{parentName:"li"},"Add the new version")),Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("strong",{parentName:"li"},"Check cluster health")),Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("strong",{parentName:"li"},"Remove the old version")),Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("strong",{parentName:"li"},"Check cluster health")),Object(i.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(i.b)("strong",{parentName:"li"},"Upgrade clients"))),Object(i.b)("h3",{className:"g-type-display-4"},Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#1-add-the-new-version-to-the-existing-cluster","aria-label":"1 add the new version to the existing cluster permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"1-add-the-new-version-to-the-existing-cluster","aria-hidden":""})),"1. Add the new version to the existing cluster"),Object(i.b)("p",null,"While it is possible to upgrade Nomad client nodes before servers, this guide\nrecommends upgrading servers first as many new client features will not work\nuntil servers are upgraded."),Object(i.b)("p",null,"Whether you are replacing Nomad in place on existing systems or bringing up new\nservers you should make changes incrementally, verifying cluster health at each\nstep of the upgrade."),Object(i.b)("p",null,"On a single server, install the new version of Nomad. You can do this by\njoining a new server to the cluster or by replacing or upgrading the binary\nlocally and restarting the Nomad service."),Object(i.b)("h3",{className:"g-type-display-4"},Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#2-check-cluster-health","aria-label":"2 check cluster health permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"2-check-cluster-health","aria-hidden":""})),"2. Check cluster health"),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/commands/monitor"}),"Monitor the Nomad logs")," on the remaining servers to check that the\nnew server has joined the cluster correctly."),Object(i.b)("p",null,"Run ",Object(i.b)("inlineCode",{parentName:"p"},"nomad agent-info")," on the new servers and check that the ",Object(i.b)("inlineCode",{parentName:"p"},"last_log_index"),"\nis of a similar value to the other servers. This step ensures that changes have\nbeen replicated to the new server."),Object(i.b)("pre",{className:"language-shell-session"},Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell-session"}),Object(i.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"ubuntu@nomad-server-10-1-1-4:~"),Object(i.b)("span",Object(n.a)({parentName:"code"},{className:"token command"}),Object(i.b)("span",Object(n.a)({parentName:"span"},{className:"token sh important"}),"$")," ",Object(i.b)("span",Object(n.a)({parentName:"span"},{className:"token bash language-bash"}),"nomad agent-info")),"\n",Object(i.b)("span",Object(n.a)({parentName:"code"},{className:"token output"}),"nomad\n  bootstrap = false\n  known_regions = 1\n  leader = false\n  server = true\nraft\n  applied_index = 53460\n  commit_index = 53460\n  fsm_pending = 0\n  last_contact = 54.512216ms\n  last_log_index = 53460\n  last_log_term = 1\n  last_snapshot_index = 49511\n  last_snapshot_term = 1\n  num_peers = 2\n...\n"))),Object(i.b)("p",null,"Continue with the upgrades across the servers making sure to do a single Nomad\nserver at a time. You can check state of the servers with ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/commands/server/members"}),Object(i.b)("inlineCode",{parentName:"a"},"nomad server members")),", and the state of the client nodes with ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/commands/node/status"}),Object(i.b)("inlineCode",{parentName:"a"},"nomad node status")),"."),Object(i.b)("h3",{className:"g-type-display-4"},Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#3-remove-the-old-versions-from-servers","aria-label":"3 remove the old versions from servers permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"3-remove-the-old-versions-from-servers","aria-hidden":""})),"3. Remove the old versions from servers"),Object(i.b)("p",null,"If you are doing an in place upgrade on existing servers this step is not\nnecessary as the version was changed in place."),Object(i.b)("p",null,"If you are doing an upgrade by adding new servers and removing old servers\nfrom the fleet you need to ensure that the server has left the fleet safely."),Object(i.b)("ol",null,Object(i.b)("li",Object(n.a)({parentName:"ol"},{className:"g-type-long-body"}),"Stop the service on the existing host"),Object(i.b)("li",Object(n.a)({parentName:"ol"},{className:"g-type-long-body"}),"On another server issue a ",Object(i.b)("inlineCode",{parentName:"li"},"nomad server members")," and check the status, if\nthe server is now in a left state you are safe to continue."),Object(i.b)("li",Object(n.a)({parentName:"ol"},{className:"g-type-long-body"}),"If the server is not in a left state, issue a ",Object(i.b)("inlineCode",{parentName:"li"},"nomad server force-leave <server id>"),"\nto remove the server from the cluster.")),Object(i.b)("p",null,"Monitor the logs of the other hosts in the Nomad cluster over this period."),Object(i.b)("h3",{className:"g-type-display-4"},Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#4-check-cluster-health","aria-label":"4 check cluster health permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"4-check-cluster-health","aria-hidden":""})),"4. Check cluster health"),Object(i.b)("p",null,"Use the same actions in step #2 above to confirm cluster health."),Object(i.b)("h3",{className:"g-type-display-4"},Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#5-upgrade-clients","aria-label":"5 upgrade clients permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"5-upgrade-clients","aria-hidden":""})),"5. Upgrade clients"),Object(i.b)("p",null,"Following the successful upgrade of the servers you can now update your\nclients using a similar process as the servers. You may either upgrade clients\nin-place or start new nodes on the new version. See the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://learn.hashicorp.com/nomad/operating-nomad/node-draining"}),"Workload Migration\nGuide")," for instructions on how to migrate running\nallocations from the old nodes to the new nodes with the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/commands/node/drain"}),Object(i.b)("inlineCode",{parentName:"a"},"nomad node drain"))," command."),Object(i.b)("h2",{className:"g-type-display-3"},Object(i.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#done","aria-label":"done permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"done","aria-hidden":""})),"Done!"),Object(i.b)("p",null,"You are now running the latest Nomad version. You can verify all\nClients joined by running ",Object(i.b)("inlineCode",{parentName:"p"},"nomad node status")," and checking all the clients\nare in a ",Object(i.b)("inlineCode",{parentName:"p"},"ready")," state."),Object(i.b)("h2",{className:"g-type-display-3"},Object(i.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#upgrading-to-nomad-enterprise","aria-label":"upgrading to nomad enterprise permalink"}),"\xbb"),Object(i.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"upgrading-to-nomad-enterprise","aria-hidden":""})),"Upgrading to Nomad Enterprise"),Object(i.b)("p",null,"The process of upgrading to a Nomad Enterprise version is identical to upgrading\nbetween versions of open source Nomad. The same guidance above should be\nfollowed and as always, prior to starting the upgrade please check the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/upgrade/upgrade-specific"}),"specific\nversion details")," page as some version\ndifferences may require specific steps."))}p.isMDXComponent=!0},xRb2:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/upgrade",function(){return t("OET8")}])}},[["xRb2",0,1,2,4,3,5,6]]]);