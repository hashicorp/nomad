(window.webpackJsonp=window.webpackJsonp||[]).push([[173],{"5IET":function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/configuration/vault",function(){return t("E22T")}])},E22T:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return d}));var n,c=t("wx14"),i=t("Ff2n"),s=t("q1tI"),l=t.n(s),r=t("7ljp"),b=t("j1un"),o=(l.a.createElement,n="Placement",function(e){return console.warn("Component "+n+" was not imported, exported, or provided by MDXProvider as global scope"),Object(r.b)("div",e)}),p={},m=Object(b.a)({layout:"docs",page_title:"vault Stanza - Agent Configuration",sidebar_title:"vault",description:"The \"vault\" stanza configures Nomad's integration with HashiCorp's Vault.\nWhen configured, Nomad can create and distribute Vault tokens to tasks\nautomatically.",__resourcePath:"docs/configuration/vault.mdx",__scans:{}});function d(e){var{components:a}=e,t=Object(i.a)(e,["components"]);return Object(r.b)(m,Object(c.a)({},p,t,{components:a,mdxType:"MDXLayout"}),Object(r.b)("h1",{className:"g-type-display-2"},Object(r.b)("a",Object(c.a)({parentName:"h1"},{className:"__permalink-h",href:"#vault-stanza","aria-label":"vault stanza permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h1"},{className:"__target-h",id:"vault-stanza","aria-hidden":""})),Object(r.b)("inlineCode",{parentName:"h1"},"vault")," Stanza"),Object(r.b)(o,{groups:["vault"],mdxType:"Placement"}),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"vault")," stanza configures Nomad's integration with ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://www.vaultproject.io/",title:"Vault by HashiCorp"}),"HashiCorp's\nVault"),". When configured, Nomad can create and distribute Vault tokens to\ntasks automatically. For more information on the architecture and setup, please\nsee the ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/vault-integration",title:"Nomad Vault Integration"}),"Nomad and Vault integration documentation"),"."),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"enabled")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"address")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"https://vault.company.internal:8200"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("h2",{className:"g-type-display-3"},Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#vault-parameters","aria-label":"vault parameters permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"vault-parameters","aria-hidden":""})),Object(r.b)("inlineCode",{parentName:"h2"},"vault")," Parameters"),Object(r.b)("ul",null,Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"address",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#address","aria-label":"address permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"address"))," - ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "https://vault.service.consul:8200")')," - Specifies the\naddress to the Vault server. This must include the protocol, host/ip, and port\ngiven in the format ",Object(r.b)("inlineCode",{parentName:"p"},"protocol://host:port"),". If your Vault installation is\nbehind a load balancer, this should be the address of the load balancer.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"allow_unauthenticated",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#allow_unauthenticated","aria-label":"allow_unauthenticated permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"allow_unauthenticated"))," ",Object(r.b)("inlineCode",{parentName:"p"},"(bool: true)")," - Specifies if users submitting jobs to\nthe Nomad server should be required to provide their own Vault token, proving\nthey have access to the policies listed in the job. This option should be\ndisabled in an untrusted environment.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"enabled",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#enabled","aria-label":"enabled permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"enabled"))," ",Object(r.b)("inlineCode",{parentName:"p"},"(bool: false)")," - Specifies if the Vault integration should be\nactivated.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"create_from_role",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#create_from_role","aria-label":"create_from_role permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"create_from_role"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")'),' - Specifies the role to create tokens from.\nThe token given to Nomad does not have to be created from this role but must\nhave "',Object(r.b)("inlineCode",{parentName:"p"},"update"),'" capability on "',Object(r.b)("inlineCode",{parentName:"p"},"auth/token/create/<create_from_role>"),'" path in\nVault. If this value is unset and the token is created from a role, the value\nis defaulted to the role the token is from. This is largely for backwards\ncompatibility. It is recommended to set the ',Object(r.b)("inlineCode",{parentName:"p"},"create_from_role")," field if Nomad\nis deriving child tokens from a role.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"task_token_ttl",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#task_token_ttl","aria-label":"task_token_ttl permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"task_token_ttl"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")'),' - Specifies the TTL of created tokens when\nusing a root token. This is specified using a label suffix like "30s" or "1h".')),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"ca_file",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#ca_file","aria-label":"ca_file permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"ca_file"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies an optional path to the CA\ncertificate used for Vault communication. If unspecified, this will fallback\nto the default system CA bundle, which varies by OS and version.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"ca_path",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#ca_path","aria-label":"ca_path permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"ca_path"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies an optional path to a folder\ncontaining CA certificates to be used for Vault communication. If unspecified,\nthis will fallback to the default system CA bundle, which varies by OS and\nversion.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"cert_file",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#cert_file","aria-label":"cert_file permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"cert_file"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies the path to the certificate used for\nVault communication. This must be set if\n",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/configuration/listener/tcp/#inlinecode-tls_require_and_verify_client_cert"}),"tls_require_and_verify_client_cert"),"\nis enabled in Vault.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"key_file",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#key_file","aria-label":"key_file permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"key_file"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies the path to the private key used for\nVault communication. If this is set then you need to also set\n",Object(r.b)("inlineCode",{parentName:"p"},"cert_file"),". This must be set if\n",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/configuration/listener/tcp/#inlinecode-tls_require_and_verify_client_cert"}),"tls_require_and_verify_client_cert"),"\nis enabled in Vault.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"namespace",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#namespace","aria-label":"namespace permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"namespace"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies the ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/enterprise/namespaces/index.html"}),"Vault namespace"),"\nused by the Vault integration. If non-empty, this namespace will be used on\nall Vault API calls.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"tls_server_name",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#tls_server_name","aria-label":"tls_server_name permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"tls_server_name"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies an optional string used to set\nthe SNI host when connecting to Vault via TLS.")),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"tls_skip_verify",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#tls_skip_verify","aria-label":"tls_skip_verify permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"tls_skip_verify"))," ",Object(r.b)("inlineCode",{parentName:"p"},"(bool: false)")," - Specifies if SSL peer validation should be\nenforced."),Object(r.b)("div",Object(c.a)({parentName:"li"},{className:"alert alert-danger g-type-body",role:"alert"}),Object(r.b)("p",{parentName:"div"},"It is ",Object(r.b)("strong",{parentName:"p"},"strongly discouraged")," to disable SSL verification. Instead, you\nshould install a custom CA bundle and validate against it. Disabling SSL\nverification can allow an attacker to easily compromise your cluster."))),Object(r.b)("li",Object(c.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(r.b)("a",Object(c.a)({parentName:"li"},{id:"token",className:"__target-lic","aria-hidden":""})),Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"#token","aria-label":"token permalink",className:"__permalink-lic"}),Object(r.b)("inlineCode",{parentName:"a"},"token"))," ",Object(r.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies the parent Vault token to use to derive child tokens for jobs\nrequesting tokens.\nVisit the ",Object(r.b)("a",Object(c.a)({parentName:"p"},{href:"/docs/vault-integration"}),"Vault Integration Guide"),"\nto see how to generate an appropriate token in Vault."),Object(r.b)("div",Object(c.a)({parentName:"li"},{className:"alert alert-danger g-type-body",role:"alert"}),Object(r.b)("p",{parentName:"div"},"It is ",Object(r.b)("strong",{parentName:"p"},"strongly discouraged")," to place the token as a configuration\nparameter like this, since the token could be checked into source control\naccidentally. Users should set the ",Object(r.b)("inlineCode",{parentName:"p"},"VAULT_TOKEN")," environment variable when\nstarting the agent instead.")))),Object(r.b)("h2",{className:"g-type-display-3"},Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#vault-examples","aria-label":"vault examples permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"vault-examples","aria-hidden":""})),Object(r.b)("inlineCode",{parentName:"h2"},"vault")," Examples"),Object(r.b)("p",null,"The following examples only show the ",Object(r.b)("inlineCode",{parentName:"p"},"vault")," stanzas. Remember that the\n",Object(r.b)("inlineCode",{parentName:"p"},"vault")," stanza is only valid in the placements listed above."),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#nomad-server","aria-label":"nomad server permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"nomad-server","aria-hidden":""})),"Nomad Server"),Object(r.b)("p",null,"This example shows an example Vault configuration for a Nomad server:"),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"enabled"),"     ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"ca_path"),"     ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"/etc/certs/ca"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"cert_file"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"/var/certs/vault.crt"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"key_file"),"    ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"/var/certs/vault.key"'),"\n\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# Address to communicate with Vault. The below is the default address if"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# unspecified."),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"address"),"     ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"https://vault.service.consul:8200"'),"\n\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# Embedding the token in the configuration is discouraged. Instead users"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# should set the VAULT_TOKEN environment variable when starting the Nomad"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# agent"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"token"),"       ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"debecfdc-9ed7-ea22-c6ee-948f22cdd474"'),"\n\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# Setting the create_from_role option causes Nomad to create tokens for tasks"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# via the provided role. This allows the role to manage what policies are"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token comment"}),"# allowed and disallowed for use by tasks."),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"create_from_role")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"nomad-cluster"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("h3",{className:"g-type-display-4"},Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__permalink-h",href:"#nomad-client","aria-label":"nomad client permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h3"},{className:"__target-h",id:"nomad-client","aria-hidden":""})),"Nomad Client"),Object(r.b)("p",null,"This example shows an example Vault configuration for a Nomad client:"),Object(r.b)("pre",{className:"language-hcl"},Object(r.b)("code",Object(c.a)({parentName:"pre"},{className:"language-hcl"}),Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"enabled"),"     ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token boolean"}),"true"),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"address"),"     ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"https://vault.service.consul:8200"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"ca_path"),"     ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"/etc/certs/ca"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"cert_file"),"   ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"/var/certs/vault.crt"'),"\n  ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token property"}),"key_file"),"    ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token string"}),'"/var/certs/vault.key"'),"\n",Object(r.b)("span",Object(c.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(r.b)("p",null,"The key difference is that the token is not necessary on the client."),Object(r.b)("h2",{className:"g-type-display-3"},Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__permalink-h",href:"#vault-configuration-reloads","aria-label":"vault configuration reloads permalink"}),"\xbb"),Object(r.b)("a",Object(c.a)({parentName:"h2"},{className:"__target-h",id:"vault-configuration-reloads","aria-hidden":""})),Object(r.b)("inlineCode",{parentName:"h2"},"vault")," Configuration Reloads"),Object(r.b)("p",null,"The Vault configuration can be reloaded on servers. This can be useful if a new\ntoken needs to be given to the servers without having to restart them. A reload\ncan be accomplished by sending the process a ",Object(r.b)("inlineCode",{parentName:"p"},"SIGHUP")," signal."))}d.isMDXComponent=!0}},[["5IET",0,1,2,4,3,5,6]]]);