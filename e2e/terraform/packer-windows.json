{
  "builders": [{
    "type": "amazon-ebs",
    "region": "us-east-1",
    "source_ami_filter": {
      "filters": {
        "virtualization-type": "hvm",
        "name": "Windows_Server-2016-English-Full-Base-*",
        "root-device-type": "ebs"
      },
      "owners": ["amazon"],
      "most_recent": true
    },
    "instance_type": "t2.medium",
    "ami_name": "nomad-e2e-windows-2016-{{timestamp}}",
    "ami_groups": ["all"],
    "communicator": "winrm",
    "user_data_file": "windows/bootstrap/setupwinrm.ps1",
    "winrm_username": "Administrator",
    "winrm_insecure": true,
    "winrm_use_ssl": true
  }],
  "provisioners":  [
    {
      "type": "powershell",
      "inline": [
        "Install-WindowsFeature -Name Containers",
        "net localgroup docker /add",
        "net localgroup docker $env:USERNAME /add",
        "Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force",
        "Set-PSRepository -InstallationPolicy Trusted -Name PSGallery",
        "Install-Module -Name DockerMsftProvider -Repository PSGallery -Force",
        "Install-Package -Name docker -ProviderName DockerMsftProvider -Force",
        "Set-PSRepository -InstallationPolicy Untrusted -Name PSGallery"
      ]
    },
    {
      "type": "powershell",
      "scripts": [
        "windows/bootstrap/disable-windows-updates.ps1",
        "windows/bootstrap/fix-tls.ps1"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "windows-shell",
      "inline": [
        "md C:\\ops"
      ]
    },
    {
      "type": "file",
      "source": "shared",
      "destination": "C:\\ops"
    },
    {
      "type": "powershell",
      "script": "shared/scripts/setup.ps1"
    }]
}

