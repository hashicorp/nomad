(window.webpackJsonp=window.webpackJsonp||[]).push([[258],{"5nIw":function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/job-specification/vault",function(){return t("wkqP")}])},wkqP:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return O}));var n=t("wx14"),c=t("Ff2n"),s=t("q1tI"),b=t.n(s),l=t("7ljp"),i=t("j1un"),p=(b.a.createElement,function(e){return function(a){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),Object(l.b)("div",a)}}),r=p("Placement"),o=p("EnterpriseAlert"),m={},j=Object(i.a)({layout:"docs",page_title:"vault Stanza - Job Specification",sidebar_title:"vault",description:'The "vault" stanza allows the task to specify that it requires a token from a\nHashiCorp Vault server. Nomad will automatically retrieve a Vault token for\nthe task and handle token renewal for the task.',__resourcePath:"docs/job-specification/vault.mdx",__scans:{}});function O(e){var a=e.components,t=Object(c.a)(e,["components"]);return Object(l.b)(j,Object(n.a)({},m,t,{components:a,mdxType:"MDXLayout"}),Object(l.b)("h1",{className:"g-type-display-2"},Object(l.b)("a",Object(n.a)({parentName:"h1"},{className:"__permalink-h",href:"#vault-stanza","aria-label":"vault stanza permalink"}),"\xbb"),Object(l.b)("a",Object(n.a)({parentName:"h1"},{className:"__target-h",id:"vault-stanza","aria-hidden":""})),Object(l.b)("inlineCode",{parentName:"h1"},"vault")," Stanza"),Object(l.b)(r,{groups:[["job","vault"],["job","group","vault"],["job","group","task","vault"]],mdxType:"Placement"}),Object(l.b)("p",null,"The ",Object(l.b)("inlineCode",{parentName:"p"},"vault")," stanza allows a task to specify that it requires a token from a\n",Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.vaultproject.io/",title:"Vault by HashiCorp"}),"HashiCorp Vault")," server. Nomad will automatically retrieve a Vault token\nfor the task and handle token renewal for the task. If specified at the ",Object(l.b)("inlineCode",{parentName:"p"},"group"),"\nlevel, the configuration will apply to all tasks within the group. If specified\nat the ",Object(l.b)("inlineCode",{parentName:"p"},"job")," level, the configuration will apply to all tasks within the job. If\nmultiple ",Object(l.b)("inlineCode",{parentName:"p"},"vault")," stanzas are specified, they are merged with the ",Object(l.b)("inlineCode",{parentName:"p"},"task")," stanza\ntaking the highest precedence, then the ",Object(l.b)("inlineCode",{parentName:"p"},"group"),", then the ",Object(l.b)("inlineCode",{parentName:"p"},"job"),"."),Object(l.b)("pre",{className:"language-hcl"},Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"job ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"docs"')," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  group ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"example"')," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    task ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"server"')," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n      ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n        ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"policies")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"cdn"'),", ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"frontend"'),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n\n        ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"change_mode"),"   ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"signal"'),"\n        ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"change_signal")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"SIGUSR1"'),"\n      ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n    ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(l.b)("p",null,"The Nomad client will make the Vault token available to the task by writing it\nto the secret directory at ",Object(l.b)("inlineCode",{parentName:"p"},"secrets/vault_token")," and by injecting a ",Object(l.b)("inlineCode",{parentName:"p"},"VAULT_TOKEN"),"\nenvironment variable. If the Nomad cluster is ",Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/configuration/vault#namespace"}),"configured"),"\nto use ",Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.vaultproject.io/docs/enterprise/namespaces"}),"Vault Namespaces"),",\na ",Object(l.b)("inlineCode",{parentName:"p"},"VAULT_NAMESPACE")," environment variable will be injected whenever ",Object(l.b)("inlineCode",{parentName:"p"},"VAULT_TOKEN")," is set."),Object(l.b)("p",null,"If Nomad is unable to renew the Vault token (perhaps due to a Vault outage or\nnetwork error), the client will attempt to retrieve a new Vault token. If successful, the\ncontents of the secrets file are updated on disk, and action will be taken\naccording to the value set in the ",Object(l.b)("inlineCode",{parentName:"p"},"change_mode")," parameter."),Object(l.b)("p",null,"If a ",Object(l.b)("inlineCode",{parentName:"p"},"vault")," stanza is specified, the ",Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/job-specification/template",title:"Nomad template Job Specification"}),Object(l.b)("inlineCode",{parentName:"a"},"template"))," stanza can interact\nwith Vault as well."),Object(l.b)("h2",{className:"g-type-display-3"},Object(l.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#vault-parameters","aria-label":"vault parameters permalink"}),"\xbb"),Object(l.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"vault-parameters","aria-hidden":""})),Object(l.b)("inlineCode",{parentName:"h2"},"vault")," Parameters"),Object(l.b)("ul",null,Object(l.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(l.b)("a",Object(n.a)({parentName:"li"},{id:"change_mode",className:"__target-lic","aria-hidden":""})),Object(l.b)("p",{parentName:"li"},Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"#change_mode","aria-label":"change_mode permalink",className:"__permalink-lic"}),Object(l.b)("inlineCode",{parentName:"a"},"change_mode"))," ",Object(l.b)("inlineCode",{parentName:"p"},'(string: "restart")')," - Specifies the behavior Nomad should take\nif the Vault token changes. The possible values are:"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(l.b)("a",Object(n.a)({parentName:"li"},{id:"noop",className:"__target-lic","aria-hidden":""})),Object(l.b)("a",Object(n.a)({parentName:"li"},{href:"#noop","aria-label":"noop permalink",className:"__permalink-lic"}),Object(l.b)("inlineCode",{parentName:"a"},'"noop"'))," - take no action (continue running the task)"),Object(l.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(l.b)("a",Object(n.a)({parentName:"li"},{id:"restart",className:"__target-lic","aria-hidden":""})),Object(l.b)("a",Object(n.a)({parentName:"li"},{href:"#restart","aria-label":"restart permalink",className:"__permalink-lic"}),Object(l.b)("inlineCode",{parentName:"a"},'"restart"'))," - restart the task"),Object(l.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(l.b)("a",Object(n.a)({parentName:"li"},{id:"signal",className:"__target-lic","aria-hidden":""})),Object(l.b)("a",Object(n.a)({parentName:"li"},{href:"#signal","aria-label":"signal permalink",className:"__permalink-lic"}),Object(l.b)("inlineCode",{parentName:"a"},'"signal"'))," - send a configurable signal to the task"))),Object(l.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(l.b)("a",Object(n.a)({parentName:"li"},{id:"change_signal",className:"__target-lic","aria-hidden":""})),Object(l.b)("p",{parentName:"li"},Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"#change_signal","aria-label":"change_signal permalink",className:"__permalink-lic"}),Object(l.b)("inlineCode",{parentName:"a"},"change_signal"))," ",Object(l.b)("inlineCode",{parentName:"p"},'(string: "")')," - Specifies the signal to send to the task as a\nstring like ",Object(l.b)("inlineCode",{parentName:"p"},'"SIGUSR1"')," or ",Object(l.b)("inlineCode",{parentName:"p"},'"SIGINT"'),". This option is required if the\n",Object(l.b)("inlineCode",{parentName:"p"},"change_mode")," is ",Object(l.b)("inlineCode",{parentName:"p"},"signal"),".")),Object(l.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(l.b)("a",Object(n.a)({parentName:"li"},{id:"env",className:"__target-lic","aria-hidden":""})),Object(l.b)("p",{parentName:"li"},Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"#env","aria-label":"env permalink",className:"__permalink-lic"}),Object(l.b)("inlineCode",{parentName:"a"},"env"))," ",Object(l.b)("inlineCode",{parentName:"p"},"(bool: true)")," - Specifies if the ",Object(l.b)("inlineCode",{parentName:"p"},"VAULT_TOKEN")," and ",Object(l.b)("inlineCode",{parentName:"p"},"VAULT_NAMESPACE"),"\nenvironment variables should be set when starting the task.")),Object(l.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(l.b)("a",Object(n.a)({parentName:"li"},{id:"namespace",className:"__target-lic","aria-hidden":""})),Object(l.b)("p",{parentName:"li"},Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"#namespace","aria-label":"namespace permalink",className:"__permalink-lic"}),Object(l.b)("inlineCode",{parentName:"a"},"namespace"))," ",Object(l.b)("inlineCode",{parentName:"p"},'(string: "")')," ",Object(l.b)(o,{inline:!0,mdxType:"EnterpriseAlert"})," - Specifies the Vault Namespace\nto use for the task. The Nomad client will retrieve a Vault token that is scoped to\nthis particular namespace.")),Object(l.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(l.b)("a",Object(n.a)({parentName:"li"},{id:"policies",className:"__target-lic","aria-hidden":""})),Object(l.b)("p",{parentName:"li"},Object(l.b)("a",Object(n.a)({parentName:"p"},{href:"#policies","aria-label":"policies permalink",className:"__permalink-lic"}),Object(l.b)("inlineCode",{parentName:"a"},"policies"))," ",Object(l.b)("inlineCode",{parentName:"p"},"(array<string>: [])")," - Specifies the set of Vault policies that\nthe task requires. The Nomad client will retrieve a Vault token that is\nlimited to those policies."))),Object(l.b)("h2",{className:"g-type-display-3"},Object(l.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#vault-examples","aria-label":"vault examples permalink"}),"\xbb"),Object(l.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"vault-examples","aria-hidden":""})),Object(l.b)("inlineCode",{parentName:"h2"},"vault")," Examples"),Object(l.b)("p",null,"The following examples only show the ",Object(l.b)("inlineCode",{parentName:"p"},"vault")," stanzas. Remember that the\n",Object(l.b)("inlineCode",{parentName:"p"},"vault")," stanza is only valid in the placements listed above."),Object(l.b)("h3",{className:"g-type-display-4"},Object(l.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#retrieve-token","aria-label":"retrieve token permalink"}),"\xbb"),Object(l.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"retrieve-token","aria-hidden":""})),"Retrieve Token"),Object(l.b)("p",null,"This example tells the Nomad client to retrieve a Vault token. The token is\navailable to the task via the canonical environment variable ",Object(l.b)("inlineCode",{parentName:"p"},"VAULT_TOKEN")," and\nwritten to disk at ",Object(l.b)("inlineCode",{parentName:"p"},"secrets/vault_token"),'. The resulting token will have the\n"frontend" Vault policy attached.'),Object(l.b)("pre",{className:"language-hcl"},Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"policies")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"frontend"'),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(l.b)("h3",{className:"g-type-display-4"},Object(l.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#signal-task","aria-label":"signal task permalink"}),"\xbb"),Object(l.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"signal-task","aria-hidden":""})),"Signal Task"),Object(l.b)("p",null,"This example shows signaling the task instead of restarting it."),Object(l.b)("pre",{className:"language-hcl"},Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"policies")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"frontend"'),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"change_mode"),"   ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"signal"'),"\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"change_signal")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"SIGINT"'),"\n",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(l.b)("h3",{className:"g-type-display-4"},Object(l.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#vault-namespace","aria-label":"vault namespace permalink"}),"\xbb"),Object(l.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"vault-namespace","aria-hidden":""})),"Vault Namespace"),Object(l.b)("p",null,"This example shows specifying a particular Vault namespace for a given task."),Object(l.b)(o,{mdxType:"EnterpriseAlert"}),Object(l.b)("pre",{className:"language-hcl"},Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"vault")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"policies")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"frontend"'),Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"namespace")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"engineering/frontend"'),"\n\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"change_mode"),"   ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"signal"'),"\n  ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"change_signal")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"SIGINT"'),"\n",Object(l.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")))}O.isMDXComponent=!0}},[["5nIw",0,1,2,4,3,5,6]]]);