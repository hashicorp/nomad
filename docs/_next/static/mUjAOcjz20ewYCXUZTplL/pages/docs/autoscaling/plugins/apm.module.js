(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{g9b9:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/docs/autoscaling/plugins/apm",function(){return t("tjjb")}])},tjjb:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return i}));var n=t("wx14"),c=t("Ff2n"),s=t("q1tI"),p=t.n(s),b=t("7ljp"),r=t("j1un"),o=(p.a.createElement,{}),l=Object(r.a)({layout:"docs",page_title:"APM",sidebar_title:"APM",description:"APM plugins provide metric data points describing the resources current state.",__resourcePath:"docs/autoscaling/plugins/apm.mdx",__scans:{}});function i(e){var{components:a}=e,t=Object(c.a)(e,["components"]);return Object(b.b)(l,Object(n.a)({},o,t,{components:a,mdxType:"MDXLayout"}),Object(b.b)("h1",{className:"g-type-display-2"},Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__permalink-h",href:"#apm-plugins","aria-label":"apm plugins permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h1"},{className:"__target-h",id:"apm-plugins","aria-hidden":""})),"APM Plugins"),Object(b.b)("p",null,"APMs are used to store metrics about an applications performance and current\nstate. The APM (Application Performance Management) plugin is responsible for\nquerying the APM and returning a value which will be used to determine if\nscaling should occur."),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#prometheus-apm-plugin","aria-label":"prometheus apm plugin permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"prometheus-apm-plugin","aria-hidden":""})),"Prometheus APM Plugin"),Object(b.b)("p",null,"Use ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://prometheus.io/"}),"Prometheus")," metrics to scale your Nomad job task groups or\ncluster. The query performed on Prometheus should return a single value. You can\nuse the ",Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"https://prometheus.io/docs/prometheus/latest/querying/functions/#scalar"}),"scalar")," function in your query to achieve\nthis."),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#agent-configuration-options","aria-label":"agent configuration options permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"agent-configuration-options","aria-hidden":""})),"Agent Configuration Options"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"apm ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"prometheus"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"driver")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"prometheus"'),"\n\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"config")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n    ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"address")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"http://prometheus.my.endpoint.io:9090"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"address",className:"__target-lic","aria-hidden":""})),Object(b.b)("a",Object(n.a)({parentName:"li"},{href:"#address","aria-label":"address permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"address"))," ",Object(b.b)("inlineCode",{parentName:"li"},'(string: "http://127.0.0.1:9090")')," - The address of the Prometheus\nendpoint used to perform queries.")),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#policy-configuration-options","aria-label":"policy configuration options permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"policy-configuration-options","aria-hidden":""})),"Policy Configuration Options"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"check")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"source")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"prometheus"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"query"),"  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"scalar(avg((haproxy_server_current_sessions{backend=\\"http_back\\"}) and (haproxy_server_up{backend=\\"http_back\\"} == 1)))"'),"\n  ...\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("h2",{className:"g-type-display-3"},Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__permalink-h",href:"#nomad-apm-plugin","aria-label":"nomad apm plugin permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h2"},{className:"__target-h",id:"nomad-apm-plugin","aria-hidden":""})),"Nomad APM Plugin"),Object(b.b)("p",null,"The Nomad APM plugin allows querying the Nomad API for metric data. This provides\nan immediate starting point without addition applications but comes at the price\nof efficiency. When using this APM, it is advised to monitor Nomad carefully\nensuring it is not put under excessive load pressure."),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#agent-configuration-options-1","aria-label":"agent configuration options permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"agent-configuration-options-1","aria-hidden":""})),"Agent Configuration Options"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"apm ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"nomad-apm"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"driver")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"nomad-apm"'),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"When using a Nomad cluster with ACLs enabled, following ACL policy will provide the appropriate\npermissions for obtaining task group metrics:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),"namespace ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"default"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"policy"),"       ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"read"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"read-job"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"In order to obtain cluster level metrics, the following ACL policy will be required:"),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"node")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"policy")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"read"'),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n\nnamespace ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"default"')," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"policy"),"       ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"read"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"capabilities")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"["),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"read-job"'),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"]"),"\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#policy-configuration-options-task-groups","aria-label":"policy configuration options task groups permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"policy-configuration-options-task-groups","aria-hidden":""})),"Policy Configuration Options - Task Groups"),Object(b.b)("p",null,"The Nomad APM allows querying Nomad to understand the current resource usage of\na task group."),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"check")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"source")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"nomad-apm"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"query"),"  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"avg_cpu"'),"\n  ...\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"Querying Nomad task group metrics is be done using the ",Object(b.b)("inlineCode",{parentName:"p"},"operation_metric")," syntax,\nwhere valid operations are:"),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"avg",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#avg","aria-label":"avg permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"avg"))," - returns the average of the metric value across allocations in the task\ngroup.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"min",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#min","aria-label":"min permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"min"))," - returns the lowest metric value among the allocations in the task group.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"max",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#max","aria-label":"max permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"max"))," - returns the highest metric value among the allocations in the task\ngroup.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"sum",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#sum","aria-label":"sum permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"sum"))," - returns the sum of all the metric values for the allocations in the\ntask group."))),Object(b.b)("p",null,"The metric value can be:"),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"cpu",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#cpu","aria-label":"cpu permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"cpu"))," - CPU usage as reported by the ",Object(b.b)("inlineCode",{parentName:"p"},"nomad.client.allocs.cpu.total_percent"),"\nmetric.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"memory",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#memory","aria-label":"memory permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"memory"))," - Memory usage as reported by the ",Object(b.b)("inlineCode",{parentName:"p"},"nomad.client.allocs.memory.usage"),"\nmetric."))),Object(b.b)("h3",{className:"g-type-display-4"},Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__permalink-h",href:"#policy-configuration-options-client-nodes","aria-label":"policy configuration options client nodes permalink"}),"\xbb"),Object(b.b)("a",Object(n.a)({parentName:"h3"},{className:"__target-h",id:"policy-configuration-options-client-nodes","aria-hidden":""})),"Policy Configuration Options - Client Nodes"),Object(b.b)("p",null,"The Nomad APM allows querying Nomad to understand the current allocated resource\nas a percentage of the total available."),Object(b.b)("pre",{className:"language-hcl"},Object(b.b)("code",Object(n.a)({parentName:"pre"},{className:"language-hcl"}),Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token keyword"}),"check")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"source")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"nomad-apm"'),"\n  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token property"}),"query"),"  ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"=")," ",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token string"}),'"percentage-allocated_cpu"'),"\n  ...\n",Object(b.b)("span",Object(n.a)({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(b.b)("p",null,"Querying Nomad client node metrics is be done using the ",Object(b.b)("inlineCode",{parentName:"p"},"operation_metric")," syntax,\nwhere valid operations are:"),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"percentage-allocated",className:"__target-lic","aria-hidden":""})),Object(b.b)("a",Object(n.a)({parentName:"li"},{href:"#percentage-allocated","aria-label":"percentage allocated permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"percentage-allocated"))," - returns the allocated percentage of the desired\nresource.")),Object(b.b)("p",null,"The metric value can be:"),Object(b.b)("ul",null,Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"cpu-1",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#cpu-1","aria-label":"cpu permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"cpu"))," - allocated CPU as reported by calculating total allocatable against the\ntotal allocated by the scheduler.")),Object(b.b)("li",Object(n.a)({parentName:"ul"},{className:"g-type-long-body"}),Object(b.b)("a",Object(n.a)({parentName:"li"},{id:"memory-1",className:"__target-lic","aria-hidden":""})),Object(b.b)("p",{parentName:"li"},Object(b.b)("a",Object(n.a)({parentName:"p"},{href:"#memory-1","aria-label":"memory permalink",className:"__permalink-lic"}),Object(b.b)("inlineCode",{parentName:"a"},"memory"))," - allocated memory as reported by calculating total allocatable against\nthe total allocated by the scheduler."))))}i.isMDXComponent=!0}},[["g9b9",0,1,2,4,3,5,6]]]);